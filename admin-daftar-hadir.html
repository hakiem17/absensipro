<!DOCTYPE html>
<html lang="id" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Daftar Hadir - Admin Panel</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <link rel="stylesheet" href="assets/css/admin.css" />
  </head>
  <body>
    <script>
      (function () {
        const t = localStorage.getItem("theme") || "light";
        document.documentElement.setAttribute("data-theme", t);
      })();
    </script>

    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Mobile Hamburger Menu Button - Always Visible -->
    <button class="sidebar-toggle mobile-hamburger" id="sidebarToggle" aria-label="Toggle Sidebar">
      <i class="bi bi-list"></i>
    </button>

    <div class="main-wrapper">
      <!-- Modern Sidebar -->
      <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <a href="#" class="sidebar-brand">
            <i class="bi bi-shield-check"></i>
            <span>Admin Panel</span>
          </a>
        </div>
        
        <nav class="sidebar-nav">
          <ul class="nav flex-column">
            <li class="nav-item">
              <a class="nav-link" href="admin-dashboard.html">
                <i class="bi bi-house-door"></i>
                <span>Dashboard</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="admin-manajemen-acara.html">
                <i class="bi bi-calendar-event"></i>
                <span>Manajemen Acara</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="admin-daftar-hadir.html">
                <i class="bi bi-people"></i>
                <span>Daftar Hadir</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="admin-rekap-acara.html">
                <i class="bi bi-display"></i>
                <span>Rekap Acara (Live)</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="admin-print-daftar-hadir.html">
                <i class="bi bi-printer"></i>
                <span>Print Daftar Hadir</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="admin-notulen-acara.html">
                <i class="bi bi-file-text"></i>
                <span>Notulen Acara</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" id="btn-master-ttd" data-bs-toggle="modal" data-bs-target="#modalMasterTTD">
                <i class="bi bi-pen"></i>
                <span>Master Tanda Tangan</span>
              </a>
            </li>
          </ul>
        </nav>

        <!-- Theme Toggle di Sidebar -->
        <div style="padding: 0.5rem 0.75rem;">
          <button id="theme-toggle" class="sidebar-theme-toggle">
            <i class="bi bi-sun-fill"></i>
            <span>Mode Gelap/Terang</span>
          </button>
        </div>
        
        <!-- User Info di Footer Sidebar -->
        <div class="sidebar-footer">
          <div class="sidebar-user-info">
            <div class="sidebar-user-avatar">
              <i class="bi bi-person-circle"></i>
            </div>
            <div class="sidebar-user-details">
              <div class="sidebar-user-name">Admin User</div>
              <div class="sidebar-user-role">Administrator</div>
            </div>
            <button id="btn-logout" class="sidebar-logout-btn" title="Logout">
              <i class="bi bi-box-arrow-right"></i>
            </button>
          </div>
        </div>
      </aside>

      <!-- Main Content Area -->
      <div class="main-content-wrapper">
        <!-- Modern Header -->
        <header class="top-header">
          <div class="header-left">
            <div class="header-search">
              <i class="bi bi-search"></i>
              <input type="text" placeholder="Search..." class="search-input" />
            </div>
          </div>
          
          <div class="header-right">
            <button id="theme-toggle-header" class="header-icon-btn" title="Toggle Theme">
              <i class="bi bi-sun-fill"></i>
            </button>
            <div class="header-notification">
              <button class="header-icon-btn notification-btn" title="Notifications">
                <i class="bi bi-bell"></i>
                <span class="notification-badge">3</span>
              </button>
            </div>
            <div class="header-user-profile">
              <div class="user-avatar-small">
                <i class="bi bi-person-circle"></i>
              </div>
              <span class="user-name-header">Admin</span>
              <i class="bi bi-chevron-down"></i>
            </div>
          </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
          <!-- Page Header -->
          <div class="d-flex justify-content-between align-items-center mb-4" style="padding-top: 1.5rem;">
            <div>
              <h2 class="h4 mb-1 text-gradient">Daftar Hadir Peserta</h2>
              <p class="text-muted mb-0">Kelola dan pantau kehadiran peserta acara</p>
            </div>
            <a href="admin-manajemen-acara.html" class="btn btn-outline-secondary">
              <i class="bi bi-arrow-left me-2"></i>
              Kembali
            </a>
          </div>

          <!-- Modern Toolbar -->
          <div class="toolbar-container">
            <div class="toolbar-header">
              <h3 class="toolbar-title">Pilih Acara</h3>
              <div class="toolbar-actions">
                <button id="btn-export" class="btn btn-success">
                  <i class="bi bi-file-earmark-spreadsheet me-2"></i>
                  Export CSV
                </button>
                <button id="btn-signature-settings" class="btn btn-outline-secondary">
                  <i class="bi bi-person-badge me-2"></i>
                  Pengaturan Penandatangan
                </button>
                <button id="btn-copy" class="btn btn-outline-primary">
                  <i class="bi bi-link-45deg me-2"></i>
                  Copy Link Form
                </button>
                <button id="btn-qr" class="btn btn-outline-primary">
                  <i class="bi bi-qr-code me-2"></i>
                  QR Form
                </button>
              </div>
            </div>
            
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label" for="event-select">Acara</label>
                <select id="event-select" class="form-select"></select>
                <div class="small text-secondary mt-2" id="event-meta"></div>
              </div>
            </div>
          </div>

          <!-- Modern Search & Filters -->
          <div class="search-filters">
            <div class="row g-3">
              <div class="col-md-6">
                <label for="search-input" class="form-label">Cari Peserta</label>
                <input
                  id="search-input"
                  class="search-input"
                  placeholder="Ketik nama, instansi, atau jabatan..."
                />
              </div>
              <div class="col-md-3">
                <label for="page-size" class="form-label">Tampil per Halaman</label>
                <select id="page-size" class="form-select">
                  <option value="10">10</option>
                  <option value="25" selected>25</option>
                  <option value="50">50</option>
                  <option value="100">100</option>
                </select>
              </div>
              <div class="col-md-3 d-flex align-items-end">
                <div class="pagination-controls">
                  <button id="btn-prev" class="btn btn-outline-secondary">
                    <i class="bi bi-chevron-left"></i>
                  </button>
                  <span id="page-info" class="btn btn-outline-secondary disabled">
                    Hal 1/1
                  </span>
                  <button id="btn-next" class="btn btn-outline-secondary">
                    <i class="bi bi-chevron-right"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Modern Table -->
          <div class="table-container">
            <div class="table-header">
              <h3 class="table-title">Daftar Hadir (<span id="count">0</span>)</h3>
            </div>
            
            <div class="table-responsive">
              <table class="table table-hover align-middle">
                <thead>
                  <tr>
                    <th style="width: 60px">#</th>
                    <th>Nama Lengkap</th>
                    <th class="col-instansi">Instansi</th>
                    <th class="col-jabatan">Jabatan</th>
                    <th class="col-gender">Jenis Kelamin</th>
                    <th>Waktu Kehadiran</th>
                    <th>Tanda Tangan</th>
                    <th class="col-aksi" style="width: 80px">Aksi</th>
                  </tr>
                </thead>
                <tbody id="tbody"></tbody>
              </table>
            </div>
            
            <div class="pagination-container">
              <div class="pagination-info">
                Menampilkan data kehadiran peserta
              </div>
            </div>
          </div>

        </main>

        <!-- Modal Master Tanda Tangan -->
        <div class="modal fade" id="modalMasterTTD" tabindex="-1" aria-labelledby="modalMasterTTDLabel" aria-hidden="true">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="modalMasterTTDLabel">
                  <i class="bi bi-pen me-2"></i>
                  Master Tanda Tangan
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <!-- Tabel Data Master TTD -->
                <div class="mb-4">
                  <h6 class="mb-3">Data Master Tanda Tangan yang Tersimpan</h6>
                  <div class="table-responsive">
                    <table class="table table-bordered table-hover" id="table-master-ttd">
                      <thead class="table-light">
                        <tr>
                          <th>Nama</th>
                          <th>Jabatan</th>
                          <th>Instansi</th>
                          <th>Golongan</th>
                          <th>NIP</th>
                        </tr>
                      </thead>
                      <tbody id="tbody-master-ttd">
                        <tr>
                          <td colspan="5" class="text-center text-muted">Tidak ada data</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
                
                <hr>
                
                <!-- Form Input/Edit -->
                <h6 class="mb-3">Form Master Tanda Tangan</h6>
                <form id="form-master-ttd">
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label for="ttd-nama" class="form-label">Nama <span class="text-danger">*</span></label>
                      <input type="text" class="form-control" id="ttd-nama" required>
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="ttd-jabatan" class="form-label">Jabatan <span class="text-danger">*</span></label>
                      <input type="text" class="form-control" id="ttd-jabatan" required>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label for="ttd-instansi" class="form-label">Instansi <span class="text-danger">*</span></label>
                      <input type="text" class="form-control" id="ttd-instansi" required>
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="ttd-golongan" class="form-label">Golongan</label>
                      <input type="text" class="form-control" id="ttd-golongan">
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label for="ttd-nip" class="form-label">NIP</label>
                      <input type="text" class="form-control" id="ttd-nip">
                    </div>
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                <button type="button" class="btn btn-primary" id="btn-save-master-ttd">
                  <i class="bi bi-save me-2"></i>
                  Simpan
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Modern Footer -->
        <footer class="footer-professional">
          <div class="footer-divider"></div>
          <div class="text-center">
            &copy; <span id="copyright-year"></span> Diskominfo Hulu Sungai Tengah.
          </div>
        </footer>
      </div>
    </div>

    <!-- Modals -->
    <div
      class="modal fade"
      id="signatureModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background: var(--card-bg)">
          <div class="modal-header">
            <h5 class="modal-title">Pratinjau Tanda Tangan</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body text-center">
            <img
              id="modalSignatureImage"
              class="img-fluid"
              alt="Tanda Tangan"
            />
          </div>
        </div>
      </div>
    </div>

    <!-- Signature Settings Modal -->
    <div class="modal fade" id="signatureSettingsModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background: var(--bg-card)">
          <div class="modal-header">
            <h5 class="modal-title">Pengaturan Penandatangan</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="signature-form">
              <div class="mb-3">
                <label for="signature-name" class="form-label">Nama Lengkap</label>
                <input type="text" class="form-control" id="signature-name" placeholder="Contoh: Darkuni, S.Hut">
              </div>
              <div class="mb-3">
                <label for="signature-position" class="form-label">Jabatan Dinas</label>
                <input type="text" class="form-control" id="signature-position" placeholder="Contoh: Kepala Dinas Komunikasi, Informatika, Statistik dan Persandian">
              </div>
              <div class="mb-3">
                <label for="signature-rank" class="form-label">Pangkat Golongan</label>
                <input type="text" class="form-control" id="signature-rank" placeholder="Contoh: Pembina Tk.l">
              </div>
              <div class="mb-3">
                <label for="signature-nip" class="form-label">NIP</label>
                <input type="text" class="form-control" id="signature-nip" placeholder="Contoh: 19730131 200501 1 007">
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
            <button type="button" class="btn btn-primary" id="save-signature">Simpan</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Attendee Modal -->
    <div class="modal fade" id="editAttendeeModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background: var(--bg-card)">
          <div class="modal-header">
            <h5 class="modal-title">Edit Data Peserta</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="edit-attendee-form">
              <input type="hidden" id="edit-id" />
              <div class="mb-3">
                <label class="form-label" for="edit-name">Nama</label>
                <input type="text" class="form-control" id="edit-name" required />
              </div>
              <div class="mb-3">
                <label class="form-label" for="edit-instansi">Instansi</label>
                <input type="text" class="form-control" id="edit-instansi" />
              </div>
              <div class="mb-3">
                <label class="form-label" for="edit-jabatan">Jabatan</label>
                <input type="text" class="form-control" id="edit-jabatan" />
              </div>
              <div class="mb-3">
                <label class="form-label">Jenis Kelamin</label>
                <select id="edit-gender" class="form-select">
                  <option value="">-</option>
                  <option value="male">Laki-Laki</option>
                  <option value="female">Perempuan</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label" for="edit-email">Email</label>
                <input type="email" class="form-control" id="edit-email" />
              </div>
              <div class="mb-3">
                <label class="form-label" for="edit-phone">No. Handphone</label>
                <input type="text" class="form-control" id="edit-phone" />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
            <button type="button" class="btn btn-primary" id="btn-save-edit">Simpan</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background: var(--card-bg)">
          <div class="modal-header">
            <h5 class="modal-title">Konfirmasi</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body" id="confirmText">Yakin?</div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Batal</button
            ><button type="button" id="confirmYes" class="btn btn-danger">
              Ya, Hapus
            </button>
          </div>
        </div>
      </div>
    </div>
    <div class="modal fade" id="qrModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background: var(--card-bg)">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="bi bi-qr-code me-2"></i>QR Code Form Kehadiran
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body text-center">
            <div class="mb-3">
              <canvas id="qrCanvas" style="max-width: 100%; border: 1px solid var(--border-color); border-radius: 8px;"></canvas>
            </div>
            <div class="small text-secondary mt-2" id="qrLink" style="word-break: break-all;"></div>
            <div class="small text-muted mt-2">
              <i class="bi bi-info-circle me-1"></i>
              Scan QR code ini untuk mengakses form kehadiran
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              Tutup
            </button>
            <button id="btn-download-qr" class="btn btn-primary">
              <i class="bi bi-download me-2"></i>Download PNG
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- JS libs -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="assets/js/config.js"></script>
    <script src="assets/js/auth.js"></script>

    <script>
      document.getElementById("copyright-year").textContent =
        new Date().getFullYear();
      // Theme toggle handled by admin-common.js

      const sb = supabase.createClient(
        window.SUPABASE_URL,
        window.SUPABASE_ANON_KEY
      );

      const $select = document.getElementById("event-select");
      const $meta = document.getElementById("event-meta");
      const $tbody = document.getElementById("tbody");
      const $count = document.getElementById("count");
      const $search = document.getElementById("search-input");
      const $pageSize = document.getElementById("page-size");
      const $btnPrev = document.getElementById("btn-prev");
      const $btnNext = document.getElementById("btn-next");
      const $pageInfo = document.getElementById("page-info");
      const $editId = document.getElementById("edit-id");
      const $editName = document.getElementById("edit-name");
      const $editInstansi = document.getElementById("edit-instansi");
      const $editJabatan = document.getElementById("edit-jabatan");
      const $editGender = document.getElementById("edit-gender");
      const $editEmail = document.getElementById("edit-email");
      const $editPhone = document.getElementById("edit-phone");
      const $btnSaveEdit = document.getElementById("btn-save-edit");
      const editModalEl = document.getElementById("editAttendeeModal");
      const editModal = editModalEl
        ? bootstrap.Modal.getOrCreateInstance(editModalEl)
        : null;
      let EVENTS = [],
        sourceList = [],
        filteredList = [],
        page = 1,
        realtimeChannel = null,
        currentEventId = null;

      const esc = (s) =>
        String(s ?? "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      const trim = (v) => (v ?? "").toString().trim();
      const fmtDT = (iso) =>
        iso
          ? new Date(iso).toLocaleString("id-ID", {
              day: "numeric",
              month: "long",
              year: "numeric",
              hour: "2-digit",
              minute: "2-digit",
            })
          : "-";
      const slug = (s) =>
        (s || "")
          .toLowerCase()
          .replace(/[^a-z0-9]+/g, "-")
          .replace(/(^-|-$)/g, "")
          .slice(0, 60);
      const escCSV = (v) => `"${String(v ?? "").replace(/"/g, '""')}"`;
      const makeCSV = (h, rows) =>
        "\uFEFF" +
        h.map(escCSV).join(",") +
        "\n" +
        rows.map((r) => r.map(escCSV).join(",")).join("\n");
      function genderLabel(g) {
        const v = (g || "").toLowerCase();
        if (v === "male") return "Laki-Laki";
        if (v === "female") return "Perempuan";
        return "";
      }
      function downloadBlob(name, blob) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = name;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(() => URL.revokeObjectURL(url), 500);
      }

      function getAttendeeById(id) {
        return sourceList.find((x) => String(x.id) === String(id));
      }

      function openEditModal(att) {
        if (!att || !editModal) return;
        $editId.value = att.id ?? "";
        $editName.value = att.name ?? "";
        $editInstansi.value = att.instansi ?? "";
        $editJabatan.value = att.jabatan ?? "";
        $editGender.value = att.gender ?? "";
        $editEmail.value = att.email ?? "";
        $editPhone.value = att.phone ?? "";
        editModal.show();
      }

      async function saveEdit() {
        const id = $editId.value;
        if (!id) return;
        const name = trim($editName.value);
        if (!name) {
          alert("Nama wajib diisi.");
          $editName.focus();
          return;
        }

        const payload = {
          name,
          instansi: trim($editInstansi.value) || null,
          jabatan: trim($editJabatan.value) || null,
          gender: trim($editGender.value) || null,
          email: trim($editEmail.value) || null,
          phone: trim($editPhone.value) || null,
        };

        $btnSaveEdit.disabled = true;
        const { error } = await sb.from("attendees").update(payload).eq("id", id);
        $btnSaveEdit.disabled = false;
        if (error) {
          alert("Gagal mengubah data: " + error.message);
          return;
        }

        const idx = sourceList.findIndex((x) => String(x.id) === String(id));
        if (idx >= 0) {
          sourceList[idx] = { ...sourceList[idx], ...payload };
        }
        applySearch(false);
        editModal.hide();
      }

      function confirmModal(message) {
        return new Promise((resolve) => {
          const mEl = document.getElementById("confirmModal");
          document.getElementById("confirmText").textContent =
            message || "Yakin?";
          const m = bootstrap.Modal.getOrCreateInstance(mEl);
          let ok = false;
          const yes = document.getElementById("confirmYes");
          const onYes = () => {
            ok = true;
            m.hide();
          };
          const onHidden = () => {
            yes.removeEventListener("click", onYes);
            mEl.removeEventListener("hidden.bs.modal", onHidden);
            resolve(ok);
          };
          yes.addEventListener("click", onYes);
          mEl.addEventListener("hidden.bs.modal", onHidden);
          m.show();
        });
      }

      async function loadEventsOnce() {
        try {
          // Show loading state
          $select.innerHTML = '<option value="">Memuat acara...</option>';
          $select.disabled = true;

          const { data, error } = await sb
            .from("events")
            .select("id,title,datetime,location,status")
            .order("datetime", { ascending: false });
          
          if (error) {
            console.error("Error loading events:", error);
            $select.innerHTML = '<option value="">Gagal memuat acara</option>';
            alert("Gagal memuat daftar acara: " + (error.message || "Terjadi kesalahan"));
            $select.disabled = false;
            return;
          }
          
          EVENTS = data || [];
          $select.disabled = false;
          
          if (!EVENTS.length) {
            $select.innerHTML = '<option value="">(belum ada acara)</option>';
            $meta.innerHTML = '<span class="text-muted">Belum ada acara yang tersedia</span>';
            return;
          }
          
          $select.innerHTML = EVENTS.map(
            (e) => `<option value="${esc(e.id)}">${esc(e.title)}</option>`
          ).join("");
          
          const urlEventId = new URLSearchParams(location.search).get("event");
          if (urlEventId && EVENTS.find((e) => e.id === urlEventId)) {
            $select.value = urlEventId;
          }
          
          await loadForEvent($select.value);
        } catch (err) {
          console.error("Unexpected error in loadEventsOnce:", err);
          $select.innerHTML = '<option value="">Error memuat acara</option>';
          $select.disabled = false;
          alert("Terjadi kesalahan saat memuat acara. Silakan refresh halaman.");
        }
      }

      async function loadForEvent(eventId) {
        try {
          if (!eventId) {
            sourceList = [];
            filteredList = [];
            page = 1;
            $meta.innerHTML = '<span class="text-muted">Pilih acara untuk melihat daftar hadir</span>';
            renderTable();
            return;
          }
          
          currentEventId = eventId;
          const ev = EVENTS.find((e) => e.id === eventId);
          
          if (!ev) {
            console.error("Event not found:", eventId);
            $meta.innerHTML = '<span class="text-danger">Acara tidak ditemukan</span>';
            sourceList = [];
            filteredList = [];
            renderTable();
            return;
          }
          
          $meta.innerHTML = `<span class="me-3"><i class="bi bi-calendar-event"></i> ${esc(
            fmtDT(ev?.datetime)
          )}</span><span class="me-3"><i class="bi bi-geo-alt"></i> ${esc(
            ev?.location || "-"
          )}</span><span class="badge ${
            ev?.status === "done" ? "text-bg-success" : "text-bg-primary"
          }">${esc(ev?.status || "")}</span>`;

          if (realtimeChannel) {
            try {
              sb.removeChannel(realtimeChannel);
            } catch (err) {
              console.warn("Error removing realtime channel:", err);
            }
            realtimeChannel = null;
          }

          // Reset pagination and search when loading new event
          page = 1;
          $search.value = "";
          
          // Show loading state in table
          $tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4"><div class="spinner-border spinner-border-sm me-2"></div>Memuat peserta...</td></tr>';
          
          const { data, error } = await sb
            .from("attendees")
            .select("id,name,instansi,jabatan,gender,email,phone,ts,signature_url")
            .eq("event_id", eventId)
            .order("ts", { ascending: true });
            
          if (error) {
            console.error("Error loading attendees:", error);
            $tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-danger"><i class="bi bi-exclamation-triangle me-2"></i>Gagal memuat peserta: ' + esc(error.message) + '</td></tr>';
            sourceList = [];
            filteredList = [];
            renderTable();
            return;
          }
          
          sourceList = (data || []).map((a) => ({
            id: a.id,
            name: a.name,
            instansi: a.instansi,
            jabatan: a.jabatan,
            gender: a.gender || null,
            email: a.email,
            phone: a.phone,
            ts: a.ts,
            signatureDataUrl: a.signature_url || null,
          }));
          
          // Setup realtime subscription
          if (realtimeChannel) {
            try {
              sb.removeChannel(realtimeChannel);
            } catch (err) {
              console.warn("Error removing realtime channel:", err);
            }
            realtimeChannel = null;
          }

          realtimeChannel = sb
            .channel(`attendees-${eventId}`)
            .on(
              "postgres_changes",
              {
                event: "INSERT",
                schema: "public",
                table: "attendees",
                filter: `event_id=eq.${eventId}`,
              },
              (p) => {
                const r = p.new;
                const item = {
                  id: r.id,
                  name: r.name,
                  instansi: r.instansi,
                  jabatan: r.jabatan,
                  gender: r.gender || null,
                  email: r.email,
                  phone: r.phone,
                  ts: r.ts,
                  signatureDataUrl: r.signature_url || null,
                };
                // Add to source list (maintain sorted order by timestamp)
                sourceList.push(item);
                sourceList.sort((a, b) => {
                  const tsA = a.ts ? new Date(a.ts).getTime() : 0;
                  const tsB = b.ts ? new Date(b.ts).getTime() : 0;
                  return tsA - tsB;
                });
                // Re-apply search filter
                applySearch(false);
              }
            )
            .on(
              "postgres_changes",
              {
                event: "DELETE",
                schema: "public",
                table: "attendees",
                filter: `event_id=eq.${eventId}`,
              },
              (p) => {
                const id = String(p.old?.id ?? "");
                sourceList = sourceList.filter((x) => String(x.id) !== id);
                // Re-apply search filter to update filtered list
                applySearch(false);
              }
            )
            .subscribe();
          
          applySearch(true);
        } catch (err) {
          console.error("Unexpected error in loadForEvent:", err);
          $tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-danger"><i class="bi bi-exclamation-triangle me-2"></i>Terjadi kesalahan saat memuat data</td></tr>';
          sourceList = [];
          filteredList = [];
          renderTable();
        }
      }

        document.getElementById("btn-export").onclick = () => {
          if (!currentEventId) {
            alert("Silakan pilih acara terlebih dahulu.");
            return;
          }
          const ev = EVENTS.find((e) => e.id === currentEventId);
          const headers = [
            "No",
            "Nama",
            "Instansi",
            "Jabatan",
            "Jenis Kelamin",
            "Email",
            "HP",
            "Waktu Hadir",
          ];
          const rows = sourceList.map((a, i) => [
            i + 1,
            a.name || "",
            a.instansi || "",
            a.jabatan || "",
            genderLabel(a.gender),
            a.email || "",
            a.phone || "",
            a.ts ? new Date(a.ts).toLocaleString("id-ID") : "",
          ]);
          downloadBlob(
            `absensi-${slug(ev?.title) || "acara"}-${currentEventId.slice(0, 8)}.csv`,
            new Blob([makeCSV(headers, rows)], {
              type: "text/csv;charset=utf-8",
            })
          );
        };
        document.getElementById("btn-copy").onclick = async () => {
          if (!currentEventId) {
            alert("Silakan pilih acara terlebih dahulu.");
            return;
          }
          const url = new URL(
            "form-kehadiran.html",
            location.origin +
              location.pathname.substring(
                0,
                location.pathname.lastIndexOf("/")
              ) +
              "/"
          );
          url.searchParams.set("event", currentEventId);
          await navigator.clipboard.writeText(url.toString());
          alert("Link form telah disalin:\n" + url);
        };
        document.getElementById("btn-qr").onclick = () => {
          if (!currentEventId) {
            alert("Silakan pilih acara terlebih dahulu.");
            return;
          }
          
          const btn = document.getElementById("btn-qr");
          const originalText = btn.innerHTML;
          btn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Membuat QR...';
          btn.disabled = true;
          
          const url = new URL(
            "form-kehadiran.html",
            location.origin +
              location.pathname.substring(
                0,
                location.pathname.lastIndexOf("/")
              ) +
              "/"
          );
          url.searchParams.set("event", currentEventId);
          const canvas = document.getElementById("qrCanvas");
          
          QRCode.toCanvas(
            canvas,
            url.toString(),
            { 
              width: 300, 
              margin: 2,
              color: {
                dark: '#000000',
                light: '#FFFFFF'
              }
            },
            (err) => {
              btn.innerHTML = originalText;
              btn.disabled = false;
              
              if (err) {
                console.error("QR Code generation error:", err);
                alert("Gagal membuat QR Code. Silakan coba lagi.");
                return;
              }
              
              document.getElementById("qrLink").textContent = url.toString();
              new bootstrap.Modal(document.getElementById("qrModal")).show();
            }
          );
        };
        document.getElementById("btn-download-qr").onclick = () => {
          const canvas = document.getElementById("qrCanvas");
          if (!canvas) return;
          canvas.toBlob((blob) => {
            if (!blob) return alert("QR belum siap.");
            const ev = EVENTS.find((e) => e.id === currentEventId);
            downloadBlob(
              `qr-form-${slug(ev?.title) || "acara"}-${currentEventId.slice(0, 8)}.png`,
              blob
            );
          }, "image/png");
        };
        
        // Signature settings functionality
        document.getElementById("btn-signature-settings").onclick = () => {
          // Load saved signature data
          const savedSignature = JSON.parse(localStorage.getItem('signatureData') || '{}');
          document.getElementById("signature-name").value = savedSignature.name || '';
          document.getElementById("signature-position").value = savedSignature.position || '';
          document.getElementById("signature-rank").value = savedSignature.rank || '';
          document.getElementById("signature-nip").value = savedSignature.nip || '';
          
          new bootstrap.Modal(document.getElementById("signatureSettingsModal")).show();
        };
        
        document.getElementById("save-signature").onclick = () => {
          const signatureData = {
            name: document.getElementById("signature-name").value,
            position: document.getElementById("signature-position").value,
            rank: document.getElementById("signature-rank").value,
            nip: document.getElementById("signature-nip").value
          };
          
          // Save to localStorage
          localStorage.setItem('signatureData', JSON.stringify(signatureData));
          
          // Close modal
          bootstrap.Modal.getInstance(document.getElementById("signatureSettingsModal")).hide();
          
          alert('Data penandatangan berhasil disimpan!');
        };

      function applySearch(resetPage) {
        const q = ($search.value || "").toLowerCase().trim();
        filteredList = q
          ? sourceList.filter(
              (a) =>
                (a.name || "").toLowerCase().includes(q) ||
                (a.instansi || "").toLowerCase().includes(q) ||
                (a.jabatan || "").toLowerCase().includes(q) ||
                (a.gender || "").toLowerCase().includes(q) ||
                genderLabel(a.gender).toLowerCase().includes(q)
            )
          : sourceList.slice();
        if (resetPage) page = 1;
        renderTable();
      }
      function pageData() {
        const size = parseInt($pageSize.value, 10) || 25;
        const total = filteredList.length;
        const totalPages = Math.max(1, Math.ceil(total / size));
        if (page > totalPages) page = totalPages;
        const start = (page - 1) * size,
          end = start + size;
        return {
          rows: filteredList.slice(start, end),
          startIndex: start,
          total,
          totalPages,
        };
      }
      function renderTable() {
        const { rows, startIndex, total, totalPages } = pageData();
        $count.textContent = total;
        
        // Clear previous content
        $tbody.innerHTML = "";
        
        if (!rows.length) {
          $tbody.innerHTML =
            '<tr><td colspan="8" class="text-center text-secondary py-4">Belum ada peserta hadir.</td></tr>';
        } else {
          // Create document fragment for better performance
          const fragment = document.createDocumentFragment();
          
          rows.forEach((a, i) => {
            const row = document.createElement("tr");
            const extraMobile =
              a.instansi || a.jabatan
                ? `<div class="d-md-none text-secondary small">${esc(
                    a.instansi || "-"
                  )}${a.jabatan ? " • " + esc(a.jabatan) : ""}</div>`
                : "";
            const ttd = a.signatureDataUrl
              ? `<img class="signature-thumbnail" src="${esc(
                  a.signatureDataUrl
                )}" alt="ttd" style="max-width: 100px; height: auto; cursor: pointer;">`
              : "-";
            
            row.innerHTML = `
              <td>${startIndex + i + 1}</td>
              <td>${esc(a.name)}${extraMobile}</td>
              <td class="col-instansi">${esc(a.instansi || "-")}</td>
              <td class="col-jabatan">${esc(a.jabatan || "-")}</td>
              <td class="col-gender">${esc(genderLabel(a.gender) || "-")}</td>
              <td>${esc(fmtDT(a.ts) || "-")}</td>
              <td>${ttd}</td>
              <td class="col-aksi text-nowrap">
                <button
                  class="btn btn-sm btn-outline-primary btn-edit me-1"
                  data-id="${esc(a.id)}"
                  title="Edit"
                  aria-label="Edit peserta"
                >
                  <i class="bi bi-pencil"></i>
                </button>
                <button
                  class="btn btn-sm btn-outline-danger btn-del"
                  data-id="${esc(a.id)}"
                  data-name="${esc(a.name || "Peserta")}"
                  title="Hapus"
                  aria-label="Hapus peserta"
                >
                  <i class="bi bi-trash"></i>
                </button>
              </td>
            `;
            fragment.appendChild(row);
          });
          
          $tbody.appendChild(fragment);
        }
        
        // Update pagination info
        $pageInfo.textContent = `Hal ${page}/${totalPages} · ${total} entri`;
        $btnPrev.disabled = page <= 1;
        $btnNext.disabled = page >= totalPages;
        
        // Scroll to top of table on page change
        if (rows.length > 0) {
          const tableContainer = $tbody.closest('.table-responsive');
          if (tableContainer) {
            tableContainer.scrollTop = 0;
          }
        }
      }

      (async function init() {
        // Wait for admin authentication check
        const isAdmin = await AdminAuth.requireAdmin();
        if (!isAdmin) {
          // User will be redirected by requireAdmin, so we don't need to continue
          return;
        }

        document
          .getElementById("btn-logout")
          ?.addEventListener("click", (e) => {
            e.preventDefault();
            AdminAuth.logout();
          });

        $select.addEventListener("change", (e) => loadForEvent(e.target.value));
        $search.addEventListener("input", () => applySearch(true));
        $pageSize.addEventListener("change", () => {
          // Reset to page 1 when changing page size
          page = 1;
          renderTable();
        });
        $btnPrev.addEventListener("click", () => {
          if (page > 1) {
            page--;
            renderTable();
          }
        });
        $btnNext.addEventListener("click", () => {
          const { totalPages } = pageData();
          if (page < totalPages) {
            page++;
            renderTable();
          }
        });
        $tbody.addEventListener("click", (e) => {
          const img = e.target.closest(".signature-thumbnail");
          if (!img) return;
          document.getElementById("modalSignatureImage").src = img.src;
          new bootstrap.Modal(document.getElementById("signatureModal")).show();
        });
        $tbody.addEventListener("click", (e) => {
          const btn = e.target.closest(".btn-edit");
          if (!btn) return;
          const id = btn.dataset.id;
          if (!id) return;
          const att = getAttendeeById(id);
          openEditModal(att);
        });
        $tbody.addEventListener("click", async (e) => {
          const btn = e.target.closest(".btn-del");
          if (!btn) return;
          const id = btn.dataset.id;
          if (!id) return;
          const name = btn.dataset.name || "peserta ini";
          const ok = await confirmModal(`Hapus ${name} dari daftar hadir?`);
          if (!ok) return;
          btn.disabled = true;
          const { error } = await sb.from("attendees").delete().eq("id", id);
          btn.disabled = false;
          if (error) {
            alert("Gagal menghapus: " + error.message);
            return;
          }
          sourceList = sourceList.filter((x) => String(x.id) !== String(id));
          // Re-apply search to update filtered list and adjust pagination
          applySearch(false);
        });
        $btnSaveEdit?.addEventListener("click", saveEdit);
        
        // Load events after auth check is complete
        await loadEventsOnce();
        
        // Load saved signature data on page load
        const savedSignature = JSON.parse(localStorage.getItem('signatureData') || '{}');
        // Sidebar and theme toggle handled by admin-common.js
      })();
    </script>
    <script src="assets/js/admin-common.js"></script>
    <script>
      // ===== MASTER TANDA TANGAN =====
      let masterTTD = null;

      function updateMasterTTDTable(data) {
        const tbody = document.getElementById("tbody-master-ttd");
        if (!tbody) return;
        
        if (data) {
          tbody.innerHTML = `
            <tr>
              <td>${escapeHtml(data.nama || "-")}</td>
              <td>${escapeHtml(data.jabatan || "-")}</td>
              <td>${escapeHtml(data.instansi || "-")}</td>
              <td>${escapeHtml(data.golongan || "-")}</td>
              <td>${escapeHtml(data.nip || "-")}</td>
            </tr>
          `;
        } else {
          tbody.innerHTML = `
            <tr>
              <td colspan="5" class="text-center text-muted">Tidak ada data</td>
            </tr>
          `;
        }
      }

      function escapeHtml(text) {
        if (!text) return "";
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      async function loadMasterTTD() {
        try {
          const { data, error } = await sb
            .from("master_tanda_tangan")
            .select("*")
            .limit(1)
            .single();

          if (error && error.code !== 'PGRST116') {
            console.error("Error loading master TTD:", error);
            updateMasterTTDTable(null);
            return;
          }

          if (data) {
            masterTTD = data;
            updateMasterTTDTable(data);
            document.getElementById("ttd-nama").value = data.nama || "";
            document.getElementById("ttd-jabatan").value = data.jabatan || "";
            document.getElementById("ttd-instansi").value = data.instansi || "";
            document.getElementById("ttd-golongan").value = data.golongan || "";
            document.getElementById("ttd-nip").value = data.nip || "";
          } else {
            updateMasterTTDTable(null);
            document.getElementById("ttd-nama").value = "";
            document.getElementById("ttd-jabatan").value = "";
            document.getElementById("ttd-instansi").value = "";
            document.getElementById("ttd-golongan").value = "";
            document.getElementById("ttd-nip").value = "";
          }
        } catch (error) {
          console.error("Error loading master TTD:", error);
          updateMasterTTDTable(null);
        }
      }

      async function saveMasterTTD() {
        const nama = document.getElementById("ttd-nama").value.trim();
        const jabatan = document.getElementById("ttd-jabatan").value.trim();
        const instansi = document.getElementById("ttd-instansi").value.trim();
        const golongan = document.getElementById("ttd-golongan").value.trim();
        const nip = document.getElementById("ttd-nip").value.trim();

        if (!nama || !jabatan || !instansi) {
          alert("Nama, Jabatan, dan Instansi wajib diisi!");
          return;
        }

        try {
          const dataToSave = {
            nama,
            jabatan,
            instansi,
            golongan: golongan || null,
            nip: nip || null,
            updated_at: new Date().toISOString()
          };

          if (masterTTD && masterTTD.id) {
            const { data, error } = await sb
              .from("master_tanda_tangan")
              .update(dataToSave)
              .eq("id", masterTTD.id)
              .select()
              .single();

            if (error) throw error;
            masterTTD = data;
            updateMasterTTDTable(data);
            alert("Master tanda tangan berhasil diperbarui!");
          } else {
            const { data, error } = await sb
              .from("master_tanda_tangan")
              .insert(dataToSave)
              .select()
              .single();

            if (error) throw error;
            masterTTD = data;
            updateMasterTTDTable(data);
            alert("Master tanda tangan berhasil disimpan!");
          }

          await loadMasterTTD();
          const modal = bootstrap.Modal.getInstance(document.getElementById("modalMasterTTD"));
          if (modal) modal.hide();
        } catch (error) {
          console.error("Error saving master TTD:", error);
          alert("Gagal menyimpan master tanda tangan: " + error.message);
        }
      }

      document.addEventListener("DOMContentLoaded", function() {
        const btnSave = document.getElementById("btn-save-master-ttd");
        const modal = document.getElementById("modalMasterTTD");
        
        if (btnSave) {
          btnSave.addEventListener("click", saveMasterTTD);
        }
        
        if (modal) {
          modal.addEventListener("show.bs.modal", loadMasterTTD);
        }
      });
    </script>
  </body>
</html>
