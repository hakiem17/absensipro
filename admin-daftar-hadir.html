<!DOCTYPE html>
<html lang="id" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Daftar Hadir - Admin Panel</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />

    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap");

      /* --- MODERN CSS VARIABLES --- */
      :root {
        --sidebar-w: 280px;
        --header-h: 70px;
        --border-radius: 12px;
        --border-radius-lg: 16px;
        --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --gradient-success: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        --gradient-warning: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        --gradient-info: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
      }

      :root[data-theme="light"] {
        --bg-main: #f8fafc;
        --bg-sidebar: #ffffff;
        --bg-card: #ffffff;
        --text-primary: #1e293b;
        --text-secondary: #64748b;
        --text-muted: #94a3b8;
        --border-color: #e2e8f0;
        --border-hover: #cbd5e1;
        --nav-link-hover-bg: #f1f5f9;
        --nav-link-active-bg: #eff6ff;
        --nav-link-active-color: #3b82f6;
        --header-bg: #ffffff;
        --footer-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      :root[data-theme="dark"] {
        --bg-main: #0f172a;
        --bg-sidebar: #1e293b;
        --bg-card: #334155;
        --text-primary: #f8fafc;
        --text-secondary: #cbd5e1;
        --text-muted: #94a3b8;
        --border-color: #475569;
        --border-hover: #64748b;
        --nav-link-hover-bg: rgba(255, 255, 255, 0.05);
        --nav-link-active-bg: rgba(59, 130, 246, 0.1);
        --nav-link-active-color: #60a5fa;
        --header-bg: #1e293b;
        --footer-bg: linear-gradient(135deg, #1e293b 0%, #334155 100%);
      }

      /* --- MODERN RESET & BASE --- */
      * {
        box-sizing: border-box;
      }

      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }

      body {
        background-color: var(--bg-main);
        color: var(--text-primary);
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        font-size: 14px;
        line-height: 1.6;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      /* --- MODERN LAYOUT SYSTEM --- */
      .main-wrapper {
        display: grid;
        grid-template-columns: 0 1fr;
        grid-template-rows: var(--header-h) 1fr auto;
        grid-template-areas: 
          "sidebar header"
          "sidebar main"
          "sidebar footer";
        min-height: 100vh;
        transition: var(--transition);
      }

      @media (min-width: 992px) {
        .main-wrapper {
          grid-template-columns: var(--sidebar-w) 1fr;
        }
      }

      /* --- MODERN SIDEBAR --- */
      .sidebar {
        grid-area: sidebar;
        background: var(--bg-sidebar);
        border-right: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        width: var(--sidebar-w);
        z-index: 1000;
        transform: translateX(-100%);
        transition: var(--transition);
        box-shadow: var(--shadow-lg);
      }

      @media (min-width: 992px) {
        .sidebar {
          position: static;
          transform: translateX(0);
          box-shadow: none;
        }
      }

      .sidebar.show {
        transform: translateX(0);
      }

      .sidebar-header {
        padding: 1.5rem;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .sidebar-brand {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-primary);
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .sidebar-brand i {
        font-size: 1.5rem;
        background: var(--gradient-primary);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .sidebar-nav {
        flex: 1;
        padding: 1rem 0;
        overflow-y: auto;
      }

      .nav-item {
        margin: 0.25rem 0;
      }

      .nav-link {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1.5rem;
        color: var(--text-secondary);
        text-decoration: none;
        font-weight: 500;
        font-size: 0.875rem;
        border-radius: 0;
        transition: var(--transition);
        position: relative;
      }

      .nav-link:hover {
        background: var(--nav-link-hover-bg);
        color: var(--text-primary);
        transform: translateX(4px);
      }

      .nav-link.active {
        background: var(--nav-link-active-bg);
        color: var(--nav-link-active-color);
        font-weight: 600;
      }

      .nav-link.active::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 3px;
        background: var(--nav-link-active-color);
        border-radius: 0 2px 2px 0;
      }

      .nav-link i {
        font-size: 1.125rem;
        width: 20px;
        text-align: center;
      }

      .sidebar-footer {
        padding: 1rem 1.5rem;
        border-top: 1px solid var(--border-color);
      }

      /* --- MODERN HEADER --- */
      .top-header {
        grid-area: header;
        background: var(--header-bg);
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 1.5rem;
        height: var(--header-h);
        position: sticky;
        top: 0;
        z-index: 100;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .sidebar-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        border: none;
        background: var(--bg-card);
        color: var(--text-secondary);
        border-radius: var(--border-radius);
        transition: var(--transition);
        cursor: pointer;
      }

      .sidebar-toggle:hover {
        background: var(--nav-link-hover-bg);
        color: var(--text-primary);
      }

      @media (min-width: 992px) {
        .sidebar-toggle {
          display: none;
        }
      }

      .header-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
      }

      .header-right {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .theme-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        border: none;
        background: var(--bg-card);
        color: var(--text-secondary);
        border-radius: var(--border-radius);
        transition: var(--transition);
        cursor: pointer;
      }

      .theme-toggle:hover {
        background: var(--nav-link-hover-bg);
        color: var(--text-primary);
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--text-secondary);
        font-size: 0.875rem;
      }

      /* --- MODERN MAIN CONTENT --- */
      .main-content-wrapper {
        grid-area: main;
        display: flex;
        flex-direction: column;
        min-height: 0;
      }

      .main-content {
        flex: 1;
        padding: 2rem;
        overflow-y: auto;
      }

      @media (max-width: 768px) {
        .main-content {
          padding: 1rem;
        }
      }

      /* --- MODERN TOOLBAR --- */
      .toolbar-container {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-lg);
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: var(--shadow-sm);
      }

      .toolbar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
      }

      .toolbar-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
      }

      .toolbar-actions {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
      }

      /* --- MODERN SEARCH & FILTERS --- */
      .search-filters {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-lg);
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: var(--shadow-sm);
      }

      .search-input {
        background: var(--bg-main);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
        transition: var(--transition);
        width: 100%;
      }

      .search-input:focus {
        outline: none;
        border-color: var(--nav-link-active-color);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .form-select {
        background: var(--bg-main);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        padding: 0.75rem;
        font-size: 0.875rem;
        transition: var(--transition);
      }

      .form-select:focus {
        outline: none;
        border-color: var(--nav-link-active-color);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      /* --- MODERN TABLE --- */
      .table-container {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-lg);
        overflow: hidden;
        box-shadow: var(--shadow-sm);
      }

      .table-header {
        padding: 1.5rem;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .table-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
      }

      .table {
        --bs-table-bg: var(--bg-card);
        --bs-table-color: var(--text-primary);
        --bs-table-border-color: var(--border-color);
        margin: 0;
      }

      .table th {
        background: var(--nav-link-hover-bg);
        color: var(--text-primary);
        font-weight: 600;
        font-size: 0.875rem;
        padding: 1rem;
        border-bottom: 1px solid var(--border-color);
      }

      .table td {
        padding: 1rem;
        border-bottom: 1px solid var(--border-color);
        vertical-align: middle;
      }

      .table tbody tr:hover {
        background: var(--nav-link-hover-bg);
      }

      .signature-thumbnail {
        width: 80px;
        height: 40px;
        object-fit: contain;
        background: var(--bg-main);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        cursor: pointer;
        transition: var(--transition);
      }

      .signature-thumbnail:hover {
        transform: scale(1.05);
        box-shadow: var(--shadow-md);
      }

      /* --- MODERN PAGINATION --- */
      .pagination-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.5rem;
        border-top: 1px solid var(--border-color);
        background: var(--bg-card);
      }

      .pagination-info {
        color: var(--text-secondary);
        font-size: 0.875rem;
      }

      .pagination-controls {
        display: flex;
        gap: 0.5rem;
        align-items: center;
      }

      /* --- MODERN BUTTONS --- */
      .btn {
        border-radius: var(--border-radius);
        font-weight: 500;
        transition: var(--transition);
        border: none;
        padding: 0.75rem 1.5rem;
        font-size: 0.875rem;
      }

      .btn-primary {
        background: var(--gradient-primary);
        border: none;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
      }

      .btn-success {
        background: var(--gradient-success);
        border: none;
      }

      .btn-danger {
        background: var(--gradient-warning);
        border: none;
      }

      .btn-outline-primary {
        border: 1px solid var(--nav-link-active-color);
        color: var(--nav-link-active-color);
        background: transparent;
      }

      .btn-outline-primary:hover {
        background: var(--nav-link-active-color);
        color: white;
        transform: translateY(-1px);
      }

      .btn-outline-danger {
        border: 1px solid #ef4444;
        color: #ef4444;
        background: transparent;
      }

      .btn-outline-danger:hover {
        background: #ef4444;
        color: white;
        transform: translateY(-1px);
      }

      /* --- MODERN MODAL --- */
      .modal-content {
        border: none;
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-lg);
        background: var(--bg-card);
      }

      .modal-header {
        border-bottom: 1px solid var(--border-color);
        padding: 1.5rem;
      }

      .modal-title {
        font-weight: 600;
        color: var(--text-primary);
      }

      .modal-body {
        padding: 1.5rem;
      }

      .modal-footer {
        border-top: 1px solid var(--border-color);
        padding: 1.5rem;
      }

      /* --- MODERN FOOTER --- */
      .footer-professional {
        grid-area: footer;
        background: var(--footer-bg);
        color: #ffffff;
        padding: 1.5rem 2rem;
        text-align: center;
        font-size: 0.875rem;
      }

      .footer-divider {
        border-top: 1px solid rgba(255, 255, 255, 0.2);
        margin: 1rem 0;
      }

      /* --- MODERN OVERLAY --- */
      .sidebar-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
        opacity: 0;
        visibility: hidden;
        transition: var(--transition);
      }

      .sidebar-overlay.show {
        opacity: 1;
        visibility: visible;
      }

      @media (min-width: 992px) {
        .sidebar-overlay {
          display: none;
        }
      }

      /* --- RESPONSIVE TABLE --- */
      @media (max-width: 767.98px) {
        .col-instansi,
        .col-jabatan,
        .col-gender,
        .col-aksi {
          display: none;
        }
      }

      /* --- PRINT STYLES --- */
      .print-header,
      .print-separator,
      .print-title {
        display: none;
      }

      @media print {
        @page {
          size: A4 portrait;
          margin: 18mm 12mm;
        }
        body {
          font-family: "Times New Roman", serif;
        }
        #sidebar,
        .top-header,
        .footer-professional,
        #toolbar,
        #search-row,
        .col-aksi {
          display: none !important;
        }
        .main-content-wrapper {
          margin-left: 0 !important;
          width: 100% !important;
        }
        .card {
          border: none !important;
          box-shadow: none !important;
        }
        .table {
          font-size: 10pt;
          width: 100%;
        }
        .table thead {
          display: table-header-group;
        }
        .table th,
        .table td {
          border: 1px solid #000 !important;
          padding: 6px 8px !important;
          color: #000 !important;
          background-color: #fff !important;
        }
        .table thead th {
          background: #e9ecef !important;
          font-weight: bold;
        }
        .signature-thumbnail {
          height: 28px !important;
          width: auto;
          background: none;
          border: none;
        }

        .print-header {
          display: flex !important;
          align-items: center;
          text-align: center;
          margin-bottom: 0.5rem;
          color: #000 !important;
        }
        .print-logo {
          width: 85px;
          height: auto;
          margin-right: 1.5rem;
        }
        .print-header-text {
          flex-grow: 1;
          line-height: 1.3;
        }
        .print-header-text h4 {
          font-size: 16pt;
          margin: 0;
        }
        .print-header-text h3 {
          font-size: 18pt;
          font-weight: bold;
          margin: 0;
        }
        .print-header-text p {
          font-size: 9pt;
          margin: 4px 0 0;
        }
        .print-separator {
          display: block !important;
          border: none;
          border-top: 3px double #000;
          margin: 0 0 1rem 0;
        }
        .print-title {
          display: block !important;
          text-align: center;
          margin-bottom: 1.5rem !important;
        }
        .print-title h4 {
          font-weight: bold;
          text-decoration: underline;
          font-size: 14pt;
        }
        .print-title h5,
        .print-title p {
          font-size: 12pt;
        }
      }

      /* --- MODERN UTILITIES --- */
      .text-gradient {
        background: var(--gradient-primary);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      /* --- DARK MODE TEXT OVERRIDES --- */
      [data-theme="dark"] .text-secondary { 
        color: var(--text-secondary) !important; 
      }
      [data-theme="dark"] .text-muted { 
        color: var(--text-muted) !important; 
      }
    </style>
  </head>
  <body>
    <script>
      (function () {
        const t = localStorage.getItem("theme") || "dark";
        document.documentElement.setAttribute("data-theme", t);
      })();
    </script>

    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <div class="main-wrapper">
      <!-- Modern Sidebar -->
      <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <a href="#" class="sidebar-brand">
            <i class="bi bi-calendar-check"></i>
            <span>AbsensiPro</span>
          </a>
        </div>
        
        <nav class="sidebar-nav">
          <ul class="nav flex-column">
            <li class="nav-item">
              <a class="nav-link" href="admin-dashboard.html">
                <i class="bi bi-speedometer2"></i>
                <span>Dashboard</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="admin-manajemen-acara.html">
                <i class="bi bi-calendar-event"></i>
                <span>Manajemen Acara</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="#">
                <i class="bi bi-people"></i>
                <span>Daftar Hadir</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="admin-rekap-acara.html">
                <i class="bi bi-display"></i>
                <span>Rekap Acara (Live)</span>
              </a>
            </li>
          </ul>
        </nav>
        
        <div class="sidebar-footer">
          <button id="btn-logout" class="btn btn-outline-danger w-100">
            <i class="bi bi-box-arrow-right me-2"></i>
            Logout
          </button>
        </div>
      </aside>

      <!-- Main Content Area -->
      <div class="main-content-wrapper">
        <!-- Modern Header -->
        <header class="top-header">
          <div class="header-left">
            <button class="sidebar-toggle" id="sidebarToggle">
              <i class="bi bi-list"></i>
            </button>
            <h1 class="header-title">Daftar Hadir</h1>
          </div>
          
          <div class="header-right">
            <button id="theme-toggle" class="theme-toggle">
              <i class="bi bi-sun-fill"></i>
            </button>
            <div class="user-info">
              <i class="bi bi-person-circle"></i>
              <span>Selamat datang, Hakiem</span>
            </div>
          </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
          <!-- Page Header -->
          <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
              <h2 class="h4 mb-1 text-gradient">Daftar Hadir Peserta</h2>
              <p class="text-muted mb-0">Kelola dan pantau kehadiran peserta acara</p>
            </div>
            <a href="admin-manajemen-acara.html" class="btn btn-outline-secondary">
              <i class="bi bi-arrow-left me-2"></i>
              Kembali
            </a>
          </div>

          <!-- Modern Toolbar -->
          <div class="toolbar-container">
            <div class="toolbar-header">
              <h3 class="toolbar-title">Pilih Acara</h3>
              <div class="toolbar-actions">
                <button id="btn-export" class="btn btn-success">
                  <i class="bi bi-file-earmark-spreadsheet me-2"></i>
                  Export CSV
                </button>
                <button id="btn-print" class="btn btn-danger">
                  <i class="bi bi-printer me-2"></i>
                  Cetak Laporan
                </button>
                <button id="btn-copy" class="btn btn-outline-primary">
                  <i class="bi bi-link-45deg me-2"></i>
                  Copy Link Form
                </button>
                <button id="btn-qr" class="btn btn-outline-primary">
                  <i class="bi bi-qr-code me-2"></i>
                  QR Form
                </button>
              </div>
            </div>
            
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label" for="event-select">Acara</label>
                <select id="event-select" class="form-select"></select>
                <div class="small text-secondary mt-2" id="event-meta"></div>
              </div>
            </div>
          </div>

          <!-- Modern Search & Filters -->
          <div class="search-filters">
            <div class="row g-3">
              <div class="col-md-6">
                <label for="search-input" class="form-label">Cari Peserta</label>
                <input
                  id="search-input"
                  class="search-input"
                  placeholder="Ketik nama, instansi, atau jabatan..."
                />
              </div>
              <div class="col-md-3">
                <label for="page-size" class="form-label">Tampil per Halaman</label>
                <select id="page-size" class="form-select">
                  <option value="10">10</option>
                  <option value="25" selected>25</option>
                  <option value="50">50</option>
                  <option value="100">100</option>
                </select>
              </div>
              <div class="col-md-3 d-flex align-items-end">
                <div class="pagination-controls">
                  <button id="btn-prev" class="btn btn-outline-secondary">
                    <i class="bi bi-chevron-left"></i>
                  </button>
                  <span id="page-info" class="btn btn-outline-secondary disabled">
                    Hal 1/1
                  </span>
                  <button id="btn-next" class="btn btn-outline-secondary">
                    <i class="bi bi-chevron-right"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- KOP SURAT UNTUK PRINT -->
          <div class="print-header">
            <img
              src="assets/img/logo_hst.png"
              alt="Logo HST"
              class="print-logo"
            />
            <div class="print-header-text">
              <h4>PEMERINTAH KABUPATEN HULU SUNGAI TENGAH</h4>
              <h3>DINAS KOMUNIKASI DAN INFORMATIKA</h3>
              <p>
                Jalan Perintis Kemerdekaan, Desa Benawa Tengah, Barabai,
                Kalimantan Selatan 71351<br />
                Telepon (0517) 3791750, Faksimile (0517) 3791750<br />
                Laman: diskominfo.hstkab.go.id, Pos-el diskominfo@hstkab.go.id
              </p>
            </div>
          </div>
          <hr class="print-separator" />
          <div class="print-title">
            <h4 class="mb-1">DAFTAR HADIR PESERTA</h4>
            <h5 id="print-event-title" class="mb-0 fw-normal">
              (Nama Acara)
            </h5>
            <p id="print-event-meta" class="small mt-1">
              (Waktu dan Lokasi Acara)
            </p>
          </div>

          <!-- Modern Table -->
          <div class="table-container">
            <div class="table-header">
              <h3 class="table-title">Daftar Hadir (<span id="count">0</span>)</h3>
            </div>
            
            <div class="table-responsive">
              <table class="table table-hover align-middle">
                <thead>
                  <tr>
                    <th style="width: 60px">#</th>
                    <th>Nama Lengkap</th>
                    <th class="col-instansi">Instansi</th>
                    <th class="col-jabatan">Jabatan</th>
                    <th class="col-gender">Jenis Kelamin</th>
                    <th>Waktu Kehadiran</th>
                    <th>Tanda Tangan</th>
                    <th class="col-aksi" style="width: 80px">Aksi</th>
                  </tr>
                </thead>
                <tbody id="tbody"></tbody>
              </table>
            </div>
            
            <div class="pagination-container">
              <div class="pagination-info">
                Menampilkan data kehadiran peserta
              </div>
            </div>
          </div>
        </main>

        <!-- Modern Footer -->
        <footer class="footer-professional">
          <div class="footer-divider"></div>
          <div class="text-center">
            &copy; <span id="copyright-year"></span> Diskominfo Hulu Sungai Tengah.
          </div>
        </footer>
      </div>
    </div>

    <!-- Modals -->
    <div
      class="modal fade"
      id="signatureModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background: var(--card-bg)">
          <div class="modal-header">
            <h5 class="modal-title">Pratinjau Tanda Tangan</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body text-center">
            <img
              id="modalSignatureImage"
              class="img-fluid"
              alt="Tanda Tangan"
            />
          </div>
        </div>
      </div>
    </div>
    <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background: var(--card-bg)">
          <div class="modal-header">
            <h5 class="modal-title">Konfirmasi</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body" id="confirmText">Yakin?</div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Batal</button
            ><button type="button" id="confirmYes" class="btn btn-danger">
              Ya, Hapus
            </button>
          </div>
        </div>
      </div>
    </div>
    <div class="modal fade" id="qrModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background: var(--card-bg)">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="bi bi-qr-code me-2"></i>QR Code Form Kehadiran
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body text-center">
            <div class="mb-3">
              <canvas id="qrCanvas" style="max-width: 100%; border: 1px solid var(--border-color); border-radius: 8px;"></canvas>
            </div>
            <div class="small text-secondary mt-2" id="qrLink" style="word-break: break-all;"></div>
            <div class="small text-muted mt-2">
              <i class="bi bi-info-circle me-1"></i>
              Scan QR code ini untuk mengakses form kehadiran
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              Tutup
            </button>
            <button id="btn-download-qr" class="btn btn-primary">
              <i class="bi bi-download me-2"></i>Download PNG
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- JS libs -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="assets/js/config.js"></script>
    <script src="assets/js/auth.js"></script>

    <script>
      document.getElementById("copyright-year").textContent =
        new Date().getFullYear();
      const htmlEl = document.documentElement,
        themeBtn = document.getElementById("theme-toggle");
      function syncIcon() {
        themeBtn.innerHTML =
          htmlEl.getAttribute("data-theme") === "dark"
            ? '<i class="bi bi-sun-fill"></i>'
            : '<i class="bi bi-moon-fill"></i>';
      }
      themeBtn.addEventListener("click", () => {
        const t =
          htmlEl.getAttribute("data-theme") === "dark" ? "light" : "dark";
        htmlEl.setAttribute("data-theme", t);
        localStorage.setItem("theme", t);
        syncIcon();
      });
      syncIcon();

      const sb = supabase.createClient(
        window.SUPABASE_URL,
        window.SUPABASE_ANON_KEY
      );

      const $select = document.getElementById("event-select");
      const $meta = document.getElementById("event-meta");
      const $tbody = document.getElementById("tbody");
      const $count = document.getElementById("count");
      const $search = document.getElementById("search-input");
      const $pageSize = document.getElementById("page-size");
      const $btnPrev = document.getElementById("btn-prev");
      const $btnNext = document.getElementById("btn-next");
      const $pageInfo = document.getElementById("page-info");
      // Elemen baru untuk print
      const $printEventTitle = document.getElementById("print-event-title");
      const $printEventMeta = document.getElementById("print-event-meta");

      let EVENTS = [],
        sourceList = [],
        filteredList = [],
        page = 1,
        realtimeChannel = null,
        currentEventId = null;

      const esc = (s) =>
        String(s ?? "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      const fmtDT = (iso) =>
        iso
          ? new Date(iso).toLocaleString("id-ID", {
              day: "numeric",
              month: "long",
              year: "numeric",
              hour: "2-digit",
              minute: "2-digit",
            })
          : "-";
      const slug = (s) =>
        (s || "")
          .toLowerCase()
          .replace(/[^a-z0-9]+/g, "-")
          .replace(/(^-|-$)/g, "")
          .slice(0, 60);
      const escCSV = (v) => `"${String(v ?? "").replace(/"/g, '""')}"`;
      const makeCSV = (h, rows) =>
        "\uFEFF" +
        h.map(escCSV).join(",") +
        "\n" +
        rows.map((r) => r.map(escCSV).join(",")).join("\n");
      function genderLabel(g) {
        const v = (g || "").toLowerCase();
        if (v === "male") return "Laki-Laki";
        if (v === "female") return "Perempuan";
        return "";
      }
      function downloadBlob(name, blob) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = name;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(() => URL.revokeObjectURL(url), 500);
      }

      function confirmModal(message) {
        return new Promise((resolve) => {
          const mEl = document.getElementById("confirmModal");
          document.getElementById("confirmText").textContent =
            message || "Yakin?";
          const m = bootstrap.Modal.getOrCreateInstance(mEl);
          let ok = false;
          const yes = document.getElementById("confirmYes");
          const onYes = () => {
            ok = true;
            m.hide();
          };
          const onHidden = () => {
            yes.removeEventListener("click", onYes);
            mEl.removeEventListener("hidden.bs.modal", onHidden);
            resolve(ok);
          };
          yes.addEventListener("click", onYes);
          mEl.addEventListener("hidden.bs.modal", onHidden);
          m.show();
        });
      }

      async function loadEventsOnce() {
        const { data, error } = await sb
          .from("events")
          .select("id,title,datetime,location,status")
          .order("datetime", { ascending: false });
        if (error) {
          alert("Gagal memuat daftar acara.");
          return;
        }
        EVENTS = data || [];
        if (!EVENTS.length) {
          $select.innerHTML = '<option value="">(belum ada acara)</option>';
          return;
        }
        $select.innerHTML = EVENTS.map(
          (e) => `<option value="${esc(e.id)}">${esc(e.title)}</option>`
        ).join("");
        const urlEventId = new URLSearchParams(location.search).get("event");
        if (urlEventId && EVENTS.find((e) => e.id === urlEventId))
          $select.value = urlEventId;
        loadForEvent($select.value);
      }

      async function loadForEvent(eventId) {
        if (!eventId) return;
        currentEventId = eventId;
        const ev = EVENTS.find((e) => e.id === eventId);
        $meta.innerHTML = `<span class="me-3"><i class="bi bi-calendar-event"></i> ${esc(
          fmtDT(ev?.datetime)
        )}</span><span class="me-3"><i class="bi bi-geo-alt"></i> ${esc(
          ev?.location || ""
        )}</span><span class="badge ${
          ev?.status === "done" ? "text-bg-success" : "text-bg-primary"
        }">${esc(ev?.status || "")}</span>`;

        // Mengisi judul dinamis untuk keperluan print
        if ($printEventTitle)
          $printEventTitle.textContent = ev?.title || "(Nama Acara)";
        if ($printEventMeta)
          $printEventMeta.textContent = `${fmtDT(ev?.datetime)} • ${
            ev?.location || "Lokasi tidak ditentukan"
          }`;

        if (realtimeChannel) {
          try {
            sb.removeChannel(realtimeChannel);
          } catch {}
          realtimeChannel = null;
        }

        const { data, error } = await sb
          .from("attendees")
          .select("id,name,instansi,jabatan,gender,email,phone,ts,signature_url")
          .eq("event_id", eventId)
          .order("ts", { ascending: true });
        if (error) {
          alert("Gagal memuat peserta.");
          return;
        }
        sourceList = (data || []).map((a) => ({
          id: a.id,
          name: a.name,
          instansi: a.instansi,
          jabatan: a.jabatan,
          gender: a.gender || null,
          email: a.email,
          phone: a.phone,
          ts: a.ts,
          signatureDataUrl: a.signature_url || null,
        }));
        applySearch(true);

        document.getElementById("btn-export").onclick = () => {
          if (!currentEventId) {
            alert("Silakan pilih acara terlebih dahulu.");
            return;
          }
          const headers = [
            "No",
            "Nama",
            "Instansi",
            "Jabatan",
            "Jenis Kelamin",
            "Email",
            "HP",
            "Waktu Hadir",
          ];
          const rows = sourceList.map((a, i) => [
            i + 1,
            a.name || "",
            a.instansi || "",
            a.jabatan || "",
            genderLabel(a.gender),
            a.email || "",
            a.phone || "",
            a.ts ? new Date(a.ts).toLocaleString("id-ID") : "",
          ]);
          downloadBlob(
            `absensi-${slug(ev?.title) || "acara"}-${currentEventId.slice(0, 8)}.csv`,
            new Blob([makeCSV(headers, rows)], {
              type: "text/csv;charset=utf-8",
            })
          );
        };
        document.getElementById("btn-copy").onclick = async () => {
          if (!currentEventId) {
            alert("Silakan pilih acara terlebih dahulu.");
            return;
          }
          const url = new URL(
            "form-kehadiran.html",
            location.origin +
              location.pathname.substring(
                0,
                location.pathname.lastIndexOf("/")
              ) +
              "/"
          );
          url.searchParams.set("event", currentEventId);
          await navigator.clipboard.writeText(url.toString());
          alert("Link form telah disalin:\n" + url);
        };
        document.getElementById("btn-qr").onclick = () => {
          if (!currentEventId) {
            alert("Silakan pilih acara terlebih dahulu.");
            return;
          }
          
          const btn = document.getElementById("btn-qr");
          const originalText = btn.innerHTML;
          btn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Membuat QR...';
          btn.disabled = true;
          
          const url = new URL(
            "form-kehadiran.html",
            location.origin +
              location.pathname.substring(
                0,
                location.pathname.lastIndexOf("/")
              ) +
              "/"
          );
          url.searchParams.set("event", currentEventId);
          const canvas = document.getElementById("qrCanvas");
          
          QRCode.toCanvas(
            canvas,
            url.toString(),
            { 
              width: 300, 
              margin: 2,
              color: {
                dark: '#000000',
                light: '#FFFFFF'
              }
            },
            (err) => {
              btn.innerHTML = originalText;
              btn.disabled = false;
              
              if (err) {
                console.error("QR Code generation error:", err);
                alert("Gagal membuat QR Code. Silakan coba lagi.");
                return;
              }
              
              document.getElementById("qrLink").textContent = url.toString();
              new bootstrap.Modal(document.getElementById("qrModal")).show();
            }
          );
        };
        document.getElementById("btn-download-qr").onclick = () => {
          const canvas = document.getElementById("qrCanvas");
          if (!canvas) return;
          canvas.toBlob((blob) => {
            if (!blob) return alert("QR belum siap.");
            const ev = EVENTS.find((e) => e.id === currentEventId);
            downloadBlob(
              `qr-form-${slug(ev?.title) || "acara"}-${currentEventId.slice(0, 8)}.png`,
              blob
            );
          }, "image/png");
        };
        document.getElementById("btn-print").onclick = () => window.print();

        realtimeChannel = sb
          .channel(`attendees-${currentEventId}`)
          .on(
            "postgres_changes",
            {
              event: "INSERT",
              schema: "public",
              table: "attendees",
              filter: `event_id=eq.${currentEventId}`,
            },
            (p) => {
              const r = p.new;
              const item = {
                id: r.id,
                name: r.name,
                instansi: r.instansi,
                jabatan: r.jabatan,
                email: r.email,
                phone: r.phone,
                ts: r.ts,
                signatureDataUrl: r.signature_url || null,
              };
              sourceList.push(item);
              const q = ($search.value || "").toLowerCase().trim();
              if (
                !q ||
                (item.name || "").toLowerCase().includes(q) ||
                (item.instansi || "").toLowerCase().includes(q) ||
                (item.jabatan || "").toLowerCase().includes(q)
              )
                filteredList.push(item);
              renderTable();
            }
          )
          .on(
            "postgres_changes",
            {
              event: "DELETE",
              schema: "public",
              table: "attendees",
              filter: `event_id=eq.${currentEventId}`,
            },
            (p) => {
              const id = String(p.old?.id ?? "");
              sourceList = sourceList.filter((x) => String(x.id) !== id);
              filteredList = filteredList.filter((x) => String(x.id) !== id);
              renderTable();
            }
          )
          .subscribe();
      }

      function applySearch(resetPage) {
        const q = ($search.value || "").toLowerCase().trim();
        filteredList = q
          ? sourceList.filter(
              (a) =>
                (a.name || "").toLowerCase().includes(q) ||
                (a.instansi || "").toLowerCase().includes(q) ||
                (a.jabatan || "").toLowerCase().includes(q) ||
                (a.gender || "").toLowerCase().includes(q) ||
                genderLabel(a.gender).toLowerCase().includes(q)
            )
          : sourceList.slice();
        if (resetPage) page = 1;
        renderTable();
      }
      function pageData() {
        const size = parseInt($pageSize.value, 10) || 25;
        const total = filteredList.length;
        const totalPages = Math.max(1, Math.ceil(total / size));
        if (page > totalPages) page = totalPages;
        const start = (page - 1) * size,
          end = start + size;
        return {
          rows: filteredList.slice(start, end),
          startIndex: start,
          total,
          totalPages,
        };
      }
      function renderTable() {
        const { rows, startIndex, total, totalPages } = pageData();
        $count.textContent = total;
        if (!rows.length) {
          $tbody.innerHTML =
            '<tr><td colspan="7" class="text-center text-secondary">Belum ada peserta hadir.</td></tr>';
        } else {
          $tbody.innerHTML = rows
            .map((a, i) => {
              const extraMobile =
                a.instansi || a.jabatan
                  ? `<div class="d-md-none text-secondary small">${esc(
                      a.instansi || "-"
                    )}${a.jabatan ? " • " + esc(a.jabatan) : ""}</div>`
                  : "";
              const ttd = a.signatureDataUrl
                ? `<img class="signature-thumbnail" src="${esc(
                    a.signatureDataUrl
                  )}" alt="ttd">`
                : "-";
              return `<tr><td>${startIndex + i + 1}</td><td>${esc(
                a.name
              )}${extraMobile}</td><td class="col-instansi">${esc(
                a.instansi
              )}</td><td class="col-jabatan">${esc(a.jabatan)}</td><td class="col-gender">${esc(
                genderLabel(a.gender)
              )}</td><td>${esc(
                fmtDT(a.ts)
              )}</td><td>${ttd}</td><td class="col-aksi text-nowrap"><button class="btn btn-sm btn-outline-danger btn-del" data-id="${esc(
                a.id
              )}"><i class="bi bi-trash"></i></button></td></tr>`;
            })
            .join("");
        }
        $pageInfo.textContent = `Hal ${page}/${totalPages} · ${total} entri`;
        $btnPrev.disabled = page <= 1;
        $btnNext.disabled = page >= totalPages;
      }

      (function init() {
        AdminAuth.requireAdmin();
        document
          .getElementById("btn-logout")
          ?.addEventListener("click", (e) => {
            e.preventDefault();
            AdminAuth.logout();
          });
        $select.addEventListener("change", (e) => loadForEvent(e.target.value));
        $search.addEventListener("input", () => applySearch(true));
        $pageSize.addEventListener("change", () => {
          page = 1;
          renderTable();
        });
        $btnPrev.addEventListener("click", () => {
          if (page > 1) {
            page--;
            renderTable();
          }
        });
        $btnNext.addEventListener("click", () => {
          const { totalPages } = pageData();
          if (page < totalPages) {
            page++;
            renderTable();
          }
        });
        $tbody.addEventListener("click", (e) => {
          const img = e.target.closest(".signature-thumbnail");
          if (!img) return;
          document.getElementById("modalSignatureImage").src = img.src;
          new bootstrap.Modal(document.getElementById("signatureModal")).show();
        });
        $tbody.addEventListener("click", async (e) => {
          const btn = e.target.closest(".btn-del");
          if (!btn) return;
          const id = btn.dataset.id;
          if (!id) return;
          const ok = await confirmModal("Hapus peserta ini dari daftar hadir?");
          if (!ok) return;
          btn.disabled = true;
          const { error } = await sb.from("attendees").delete().eq("id", id);
          btn.disabled = false;
          if (error) {
            alert("Gagal menghapus: " + error.message);
            return;
          }
          sourceList = sourceList.filter((x) => String(x.id) !== String(id));
          filteredList = filteredList.filter(
            (x) => String(x.id) !== String(id)
          );
          renderTable();
        });
        loadEventsOnce();
        
        // Modern Sidebar Toggle
        const sidebar = document.getElementById("sidebar");
        const sidebarToggle = document.getElementById("sidebarToggle");
        const sidebarOverlay = document.getElementById("sidebarOverlay");

        function toggleSidebar() {
          sidebar.classList.toggle("show");
          sidebarOverlay.classList.toggle("show");
          document.body.style.overflow = sidebar.classList.contains("show") ? "hidden" : "";
        }

        function hideSidebar() {
          sidebar.classList.remove("show");
          sidebarOverlay.classList.remove("show");
          document.body.style.overflow = "";
        }

        // Event listeners for modern sidebar
        sidebarToggle?.addEventListener("click", toggleSidebar);
        sidebarOverlay?.addEventListener("click", hideSidebar);
        
        // Close sidebar when clicking nav links (mobile)
        sidebar.querySelectorAll(".nav-link").forEach(link => {
          link.addEventListener("click", () => {
            if (window.innerWidth < 992) {
              hideSidebar();
            }
          });
        });

        // Close sidebar on escape key
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape" && sidebar.classList.contains("show")) {
            hideSidebar();
          }
        });

        // Handle window resize
        window.addEventListener("resize", () => {
          if (window.innerWidth >= 992) {
            hideSidebar();
          }
        });
      })();
    </script>
  </body>
</html>

