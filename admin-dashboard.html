<!DOCTYPE html>
<html lang="id" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard - Admin Panel</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />

    <style>
      @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap");

      /* --- VARIABEL CSS --- */
      :root {
        --sidebar-w: 260px;
        --content-gutter-x: clamp(12px, 0.9vw, 22px);
      }

      :root[data-theme="light"] {
        --bg-main: #f8f9fa;
        --bg-sidebar: #fff;
        --text-primary: #212529;
        --text-secondary: #6c757d;
        --border-color: #dee2e6;
        --card-bg: #fff;
        --nav-link-hover-bg: rgba(0, 0, 0, 0.05);
      }
      :root[data-theme="dark"] {
        --bg-main: #1a202c;
        --bg-sidebar: #2d3748;
        --text-primary: #e2e8f0;
        --text-secondary: #a0aec0;
        --border-color: #4a5568;
        --card-bg: #2d3748;
        --nav-link-hover-bg: rgba(255, 255, 255, 0.05);
      }

      /* --- TATA LETAK UTAMA --- */
      html,
      body {
        height: 100%;
      }
      body {
        background-color: var(--bg-main);
        color: var(--text-primary);
        font-family: "Poppins", sans-serif;
      }

      .main-wrapper {
        display: flex;
        min-height: 100vh;
        width: 100%;
        overflow-x: hidden;
      }

      /* --- SIDEBAR --- */
      .sidebar {
        --bs-offcanvas-width: var(--sidebar-w);
        background-color: var(--bg-sidebar);
        z-index: 1050;
      }
      .sidebar .nav-link {
        color: var(--text-secondary);
        font-weight: 500;
        padding: 12px 20px;
        display: flex;
        align-items: center;
      }
      .sidebar .nav-link .bi {
        margin-right: 12px;
        font-size: 1.1rem;
      }
      .sidebar .nav-link:hover {
        background: var(--nav-link-hover-bg);
        color: var(--text-primary);
      }
      .sidebar .nav-link.active {
        color: #3b82f6;
        font-weight: 600;
      }

      @media (min-width: 992px) {
        .sidebar {
          position: fixed;
          left: 0;
          top: 0;
          bottom: 0;
          width: var(--sidebar-w);
          border-right: 1px solid var(--border-color);
        }
      }

      /* --- KONTEN UTAMA --- */
      .main-content-wrapper {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
      }

      @media (min-width: 992px) {
        .main-content-wrapper {
          margin-left: var(--sidebar-w);
          width: calc(100% - var(--sidebar-w));
        }
      }

      /* --- ELEMEN UMUM --- */
      .top-header {
        background-color: var(--card-bg);
        border-bottom: 1px solid var(--border-color);
      }
      .container-left {
        padding-left: var(--content-gutter-x);
        padding-right: var(--content-gutter-x);
      }
      @media (min-width: 992px) {
        .container-left {
          padding-left: 0;
        }
        .top-header .container-left {
          padding-left: var(--content-gutter-x);
          padding-right: var(--content-gutter-x);
        }
      }

      /* MENAMBAHKAN JARAK (PADDING) DI BAGIAN ATAS DAN BAWAH KONTEN UTAMA */
      .main-content {
        padding-top: 1rem;
        padding-bottom: 1rem;
      }
      @media (min-width: 768px) {
        .main-content {
          padding-top: 2rem;
          padding-bottom: 2rem;
        }
      }

      .card {
        background-color: var(--card-bg);
        border-color: var(--border-color);
      }
      .list-group-item {
        background-color: var(--card-bg);
        color: var(--text-primary);
      }

      /* --- FOOTER --- */
      .footer-professional {
        background: #3b82f6;
        color: #e5e7eb;
        margin-top: auto;
        padding: 1.5rem 0;
        font-size: 0.95rem;
      }
      .footer-professional .footer-divider {
        border-top: 1px solid #4b92f7;
        margin: 0.75rem 0;
      }
      .footer-professional .copyright {
        font-size: 0.875rem;
      }

      /* --- CHART --- */
      #attendanceChart {
        width: 100%;
      }
      @media (max-width: 575.98px) {
        #attendanceChart {
          height: 220px !important;
        }
      }
      @media (min-width: 576px) and (max-width: 991.98px) {
        #attendanceChart {
          height: 260px !important;
        }
      }
      @media (min-width: 992px) {
        #attendanceChart {
          height: 320px !important;
        }
      }
    </style>
  </head>
  <body>
    <script>
      (function () {
        const t = localStorage.getItem("theme") || "dark";
        document.documentElement.setAttribute("data-theme", t);
      })();
    </script>

    <div class="main-wrapper">
      <div
        id="sidebar"
        class="offcanvas-lg offcanvas-start sidebar"
        data-bs-scroll="true"
        data-bs-backdrop="true"
        tabindex="-1"
        aria-labelledby="sidebarLabel"
      >
        <div class="offcanvas-header d-lg-none">
          <h5 class="offcanvas-title" id="sidebarLabel">AbsensiPro</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="offcanvas"
            aria-label="Tutup"
          ></button>
        </div>
        <div class="offcanvas-body d-flex flex-column p-0">
          <div class="p-4 d-none d-lg-block">
            <h4 class="fw-bold m-0">AbsensiPro</h4>
          </div>
          <ul class="nav flex-column">
            <li class="nav-item">
              <a class="nav-link active" href="#"
                ><i class="bi bi-speedometer2"></i> Dashboard</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="admin-manajemen-acara.html"
                ><i class="bi bi-calendar-event"></i> Manajemen Acara</a
              >
            </li>
          </ul>
          <div class="p-3 mt-auto">
            <a href="#" id="btn-logout" class="btn btn-outline-danger w-100"
              ><i class="bi bi-box-arrow-right"></i> Logout</a
            >
          </div>
        </div>
      </div>

      <div class="main-content-wrapper">
        <header class="top-header">
          <div
            class="container-left d-flex align-items-center justify-content-between py-2"
          >
            <div class="d-flex align-items-center gap-2">
              <button
                class="btn btn-outline-secondary d-lg-none"
                type="button"
                data-bs-toggle="offcanvas"
                data-bs-target="#sidebar"
              >
                <i class="bi bi-list"></i>
              </button>
              <h1 class="h5 m-0 d-none d-sm-block">Dashboard</h1>
            </div>
            <div class="d-flex align-items-center gap-2">
              <button
                id="theme-toggle"
                class="btn btn-outline-secondary"
                type="button"
              >
                <i class="bi bi-sun-fill"></i>
              </button>
              <span class="ms-1 d-none d-sm-inline"
                >Selamat datang, Hakiem</span
              >
            </div>
          </div>
        </header>

        <main class="main-content">
          <div class="container-left">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <span class="h5 fw-bold d-sm-none mb-0">Dashboard</span>
              <a
                class="btn btn-primary ms-auto"
                href="admin-manajemen-acara.html"
                ><i class="bi bi-plus-circle me-2"></i>Tambah Acara Baru</a
              >
            </div>

            <div class="row g-3">
              <div class="col-6 col-md-6 col-xl-3">
                <div class="card shadow-sm h-100">
                  <div class="card-body">
                    <h6 class="text-secondary">Total Acara</h6>
                    <p class="fs-3 fw-bold mb-0" id="stat-events">—</p>
                  </div>
                </div>
              </div>
              <div class="col-6 col-md-6 col-xl-3">
                <div class="card shadow-sm h-100">
                  <div class="card-body">
                    <h6 class="text-secondary">Akan Datang/Aktif</h6>
                    <p class="fs-3 fw-bold mb-0" id="stat-events-active">—</p>
                  </div>
                </div>
              </div>
              <div class="col-6 col-md-6 col-xl-3">
                <div class="card shadow-sm h-100">
                  <div class="card-body">
                    <h6 class="text-secondary">Selesai</h6>
                    <p class="fs-3 fw-bold mb-0" id="stat-events-done">—</p>
                  </div>
                </div>
              </div>
              <div class="col-6 col-md-6 col-xl-3">
                <div class="card shadow-sm h-100">
                  <div class="card-body">
                    <h6 class="text-secondary">Total Peserta</h6>
                    <p class="fs-3 fw-bold mb-0" id="stat-attendees">—</p>
                  </div>
                </div>
              </div>
            </div>

            <div class="row g-3 mt-3">
              <div class="col-lg-7">
                <div class="card shadow-sm h-100">
                  <div class="card-header fw-bold">
                    Peserta per Acara (5 Terbaru)
                  </div>
                  <div class="card-body">
                    <canvas id="attendanceChart"></canvas>
                  </div>
                </div>
              </div>
              <div class="col-lg-5">
                <div class="card shadow-sm h-100">
                  <div class="card-header fw-bold">Acara Akan Datang</div>
                  <div class="list-group list-group-flush" id="upcoming-list">
                    <div class="list-group-item text-secondary">Memuat…</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </main>

        <footer class="footer-professional">
          <div class="container-left">
            <div class="footer-divider"></div>
            <div class="text-center copyright">
              &copy; <span id="copyright-year"></span> Diskominfo Hulu Sungai
              Tengah.
            </div>
          </div>
        </footer>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="assets/js/config.js"></script>
    <script src="assets/js/auth.js"></script>

    <script>
      // Tahun & tema
      document.getElementById("copyright-year").textContent =
        new Date().getFullYear();
      const themeToggle = document.getElementById("theme-toggle");
      function updateIcon() {
        themeToggle.querySelector("i").className =
          document.documentElement.getAttribute("data-theme") === "dark"
            ? "bi bi-sun-fill"
            : "bi bi-moon-fill";
      }
      themeToggle.addEventListener("click", () => {
        const t =
          document.documentElement.getAttribute("data-theme") === "dark"
            ? "light"
            : "dark";
        document.documentElement.setAttribute("data-theme", t);
        localStorage.setItem("theme", t);
        updateIcon();
      });
      updateIcon();

      // Supabase client
      const sb = supabase.createClient(
        window.SUPABASE_URL,
        window.SUPABASE_ANON_KEY
      );

      // Auth
      AdminAuth.requireAdmin();
      document
        .getElementById("btn-logout")
        ?.addEventListener("click", () => AdminAuth.logout());

      // Util
      const $statEvents = document.getElementById("stat-events");
      const $statActive = document.getElementById("stat-events-active");
      const $statDone = document.getElementById("stat-events-done");
      const $statAtt = document.getElementById("stat-attendees");
      const $upcoming = document.getElementById("upcoming-list");
      const chartCtx = document
        .getElementById("attendanceChart")
        .getContext("2d");
      function safeNum(n) {
        return typeof n === "number" && isFinite(n) ? n : 0;
      }
      function fmtDateShort(iso) {
        return new Date(iso).toLocaleDateString("id-ID", {
          day: "2-digit",
          month: "short",
          year: "numeric",
        });
      }

      async function loadStats() {
        const ev = await sb
          .from("events")
          .select("*", { count: "exact", head: true });
        const done = await sb
          .from("events")
          .select("*", { count: "exact", head: true })
          .eq("status", "done");
        const act = await sb
          .from("events")
          .select("*", { count: "exact", head: true })
          .neq("status", "done");
        const at = await sb
          .from("attendees")
          .select("*", { count: "exact", head: true });
        $statEvents.textContent = safeNum(ev?.count);
        $statDone.textContent = safeNum(done?.count);
        $statActive.textContent = safeNum(act?.count);
        $statAtt.textContent = safeNum(at?.count);
      }

      async function loadUpcoming() {
        const nowIso = new Date().toISOString();
        const { data, error } = await sb
          .from("events")
          .select("id,title,datetime,location,status")
          .gt("datetime", nowIso)
          .neq("status", "done")
          .order("datetime", { ascending: true })
          .limit(5);
        if (error) {
          $upcoming.innerHTML =
            '<div class="list-group-item text-danger">Gagal memuat.</div>';
          return;
        }
        if (!data || !data.length) {
          $upcoming.innerHTML =
            '<div class="list-group-item text-secondary">Tidak ada acara akan datang.</div>';
          return;
        }
        $upcoming.innerHTML = "";
        for (const ev of data) {
          const a = document.createElement("a");
          a.className = "list-group-item list-group-item-action";
          a.href = `admin-daftar-hadir.html?event=${encodeURIComponent(ev.id)}`;
          a.innerHTML = `${
            ev.title
          }<br/><small class="text-secondary">${fmtDateShort(ev.datetime)}${
            ev.location ? " • " + ev.location : ""
          }</small>`;
          $upcoming.appendChild(a);
        }
      }

      async function loadChart() {
        const { data: events, error } = await sb
          .from("events")
          .select("id,title,datetime")
          .order("datetime", { ascending: false })
          .limit(5);
        if (error || !events) return;
        const counts = await Promise.all(
          events.map(async (ev) => {
            const r = await sb
              .from("attendees")
              .select("*", { count: "exact", head: true })
              .eq("event_id", ev.id);
            return safeNum(r?.count);
          })
        );
        const labels = events
          .slice()
          .reverse()
          .map((e) => e.title);
        const values = counts.slice().reverse();
        new Chart(chartCtx, {
          type: "bar",
          data: {
            labels,
            datasets: [
              {
                label: "Jumlah Peserta",
                data: values,
                backgroundColor: "#3b82f6",
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true } },
            plugins: { legend: { display: false } },
          },
        });
      }

      (async () => {
        await Promise.all([loadStats(), loadUpcoming(), loadChart()]);
      })();

      // Offcanvas instance & safety
      const sidebarEl = document.getElementById("sidebar");
      const sidebarOC = bootstrap.Offcanvas.getOrCreateInstance(sidebarEl, {
        backdrop: true,
        scroll: true,
      });
      sidebarEl
        .querySelectorAll(
          '[data-bs-dismiss="offcanvas"], .nav-link, #btn-logout'
        )
        .forEach((el) =>
          el.addEventListener("click", () => {
            try {
              sidebarOC.hide();
            } catch (_) {}
          })
        );
      sidebarEl.addEventListener("hidden.bs.offcanvas", () => {
        document.body.style.overflow = "";
        document.body.classList.remove("offcanvas-backdrop", "modal-open");
      });
    </script>
  </body>
</html>
