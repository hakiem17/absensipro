<!DOCTYPE html>
<html lang="id" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard - Admin Panel</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <link rel="stylesheet" href="assets/css/admin.css" />
  </head>
  <body>
    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Mobile Hamburger Menu Button - Always Visible -->
    <button class="sidebar-toggle mobile-hamburger" id="sidebarToggle" aria-label="Toggle Sidebar">
      <i class="bi bi-list"></i>
    </button>

    <div class="main-wrapper">
      <!-- Modern Sidebar -->
      <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <a href="#" class="sidebar-brand">
            <i class="bi bi-shield-check"></i>
            <span>Admin Panel</span>
          </a>
        </div>
        
        <nav class="sidebar-nav">
          <ul class="nav flex-column">
            <li class="nav-item">
              <a class="nav-link active" href="admin-dashboard.html">
                <i class="bi bi-house-door"></i>
                <span>Dashboard</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="admin-manajemen-acara.html">
                <i class="bi bi-calendar-event"></i>
                <span>Manajemen Acara</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="admin-daftar-hadir.html">
                <i class="bi bi-people"></i>
                <span>Daftar Hadir</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="admin-rekap-acara.html">
                <i class="bi bi-display"></i>
                <span>Rekap Acara (Live)</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="admin-print-daftar-hadir.html">
                <i class="bi bi-printer"></i>
                <span>Print Daftar Hadir</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="admin-notulen-acara.html">
                <i class="bi bi-file-text"></i>
                <span>Notulen Acara</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" id="btn-master-ttd" data-bs-toggle="modal" data-bs-target="#modalMasterTTD">
                <i class="bi bi-pen"></i>
                <span>Master Tanda Tangan</span>
              </a>
            </li>
          </ul>
        </nav>

        <!-- Theme Toggle di Sidebar -->
        <div style="padding: 0.5rem 0.75rem;">
          <button id="theme-toggle" class="sidebar-theme-toggle">
            <i class="bi bi-sun-fill"></i>
            <span>Mode Gelap/Terang</span>
          </button>
        </div>
        
        <!-- User Info di Footer Sidebar -->
        <div class="sidebar-footer">
          <div class="sidebar-user-info">
            <div class="sidebar-user-avatar">
              <i class="bi bi-person-circle"></i>
            </div>
            <div class="sidebar-user-details">
              <div class="sidebar-user-name">Admin User</div>
              <div class="sidebar-user-role">Administrator</div>
            </div>
            <button id="btn-logout" class="sidebar-logout-btn" title="Logout">
              <i class="bi bi-box-arrow-right"></i>
            </button>
          </div>
        </div>
      </aside>

      <!-- Main Content Area -->
      <div class="main-content-wrapper">
        <!-- Modern Header -->
        <header class="top-header">
          <div class="header-left">
            <div class="header-search">
              <i class="bi bi-search"></i>
              <input type="text" placeholder="Search..." class="search-input" />
            </div>
          </div>
          
          <div class="header-right">
            <button id="theme-toggle-header" class="header-icon-btn" title="Toggle Theme">
              <i class="bi bi-sun-fill"></i>
            </button>
            <div class="header-notification">
              <button class="header-icon-btn notification-btn" title="Notifications">
                <i class="bi bi-bell"></i>
                <span class="notification-badge">3</span>
              </button>
            </div>
            <div class="header-user-profile">
              <div class="user-avatar-small">
                <i class="bi bi-person-circle"></i>
              </div>
              <span class="user-name-header">Admin</span>
              <i class="bi bi-chevron-down"></i>
            </div>
          </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
          <!-- Page Header -->
          <div class="d-flex justify-content-between align-items-center mb-4 flex-shrink: 0" style="padding-top: 1.5rem;">
            <div>
              <h2 class="h4 mb-1 text-gradient fw-bold">Dashboard Overview</h2>
              <p class="text-muted mb-0 small">Ringkasan statistik dan aktivitas terbaru</p>
            </div>
            <div class="d-flex align-items-center gap-2">
              <label for="year-filter" class="form-label mb-0 small text-muted fw-medium">Tahun:</label>
              <select id="year-filter" class="form-select form-select-sm" style="width: auto; min-width: 120px;">
                <option value="">Memuat...</option>
              </select>
              <a class="btn btn-primary btn-sm" href="admin-manajemen-acara.html?add=true">
                <i class="bi bi-plus-circle me-2"></i>
                Tambah Acara
              </a>
            </div>
          </div>

          <!-- Modern Stats Grid -->
          <div class="stats-grid" id="stats-grid">
            <div class="stat-card fade-in">
              <div class="stat-icon">
                <i class="bi bi-calendar-event"></i>
              </div>
              <div class="stat-label">
                <span class="tooltip-wrapper">
                  Total Acara
                  <span class="tooltip-text">Jumlah total semua acara yang telah dibuat</span>
                </span>
              </div>
              <div class="stat-value" id="stat-events">
                <div class="skeleton skeleton-value"></div>
              </div>
            </div>
            
            <div class="stat-card success fade-in" style="animation-delay: 0.1s">
              <div class="stat-icon">
                <i class="bi bi-play-circle"></i>
              </div>
              <div class="stat-label">
                <span class="tooltip-wrapper">
                  Akan Datang/Aktif
                  <span class="tooltip-text">Acara yang masih aktif atau akan datang</span>
                </span>
              </div>
              <div class="stat-value" id="stat-events-active">
                <div class="skeleton skeleton-value"></div>
              </div>
            </div>
            
            <div class="stat-card warning fade-in" style="animation-delay: 0.2s">
              <div class="stat-icon">
                <i class="bi bi-check-circle"></i>
              </div>
              <div class="stat-label">
                <span class="tooltip-wrapper">
                  Selesai
                  <span class="tooltip-text">Acara yang sudah selesai dilaksanakan</span>
                </span>
              </div>
              <div class="stat-value" id="stat-events-done">
                <div class="skeleton skeleton-value"></div>
              </div>
            </div>
            
            <div class="stat-card info fade-in" style="animation-delay: 0.3s">
              <div class="stat-icon">
                <i class="bi bi-people"></i>
              </div>
              <div class="stat-label">
                <span class="tooltip-wrapper">
                  Total Peserta
                  <span class="tooltip-text">Jumlah total peserta dari semua acara</span>
                </span>
              </div>
              <div class="stat-value" id="stat-attendees">
                <div class="skeleton skeleton-value"></div>
              </div>
            </div>
          </div>

          <!-- Content Grid -->
          <div class="content-grid">
            <!-- Chart Section -->
            <div class="card fade-in">
              <div class="card-header collapsible" data-target="chart-body">
                <h5 class="mb-0" style="font-size: 0.9375rem;">
                  <i class="bi bi-bar-chart me-2"></i>
                  Peserta per Acara (5 Terbaru)
                  <span class="tooltip-wrapper ms-2">
                    <i class="bi bi-info-circle" style="font-size: 0.75rem;"></i>
                    <span class="tooltip-text">Grafik menampilkan jumlah peserta dari 5 acara terbaru</span>
                  </span>
                </h5>
              </div>
              <div class="card-body collapsible" id="chart-body" style="overflow: hidden;">
                <div class="chart-container">
                  <div id="chart-loading" class="text-center py-5">
                    <div class="skeleton skeleton-text mb-2"></div>
                    <div class="skeleton skeleton-text mb-2" style="width: 80%;"></div>
                    <div class="skeleton skeleton-text" style="width: 60%;"></div>
                  </div>
                  <canvas id="attendanceChart" style="display: none;"></canvas>
                  <div id="chart-empty" class="empty-state" style="display: none;">
                    <div class="empty-state-icon">
                      <i class="bi bi-bar-chart"></i>
                    </div>
                    <div class="empty-state-title">Tidak ada data</div>
                    <div class="empty-state-text">Belum ada acara yang memiliki peserta</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Upcoming Events -->
            <div class="card fade-in" style="animation-delay: 0.1s">
              <div class="card-header collapsible" data-target="upcoming-body">
                <h5 class="mb-0" style="font-size: 0.9375rem;">
                  <i class="bi bi-clock me-2"></i>
                  Acara Akan Datang
                  <span class="tooltip-wrapper ms-2">
                    <i class="bi bi-info-circle" style="font-size: 0.75rem;"></i>
                    <span class="tooltip-text">Daftar 5 acara terdekat yang akan datang</span>
                  </span>
                </h5>
              </div>
              <div class="card-body collapsible p-0" id="upcoming-body" style="overflow-y: auto; max-height: 100%;">
                <div class="list-group list-group-flush" id="upcoming-list">
                  <div class="list-group-item text-secondary">
                    <div class="d-flex align-items-center">
                      <div class="skeleton skeleton-text me-2" style="width: 20px; height: 20px;"></div>
                      <div class="flex-grow-1">
                        <div class="skeleton skeleton-text mb-2"></div>
                        <div class="skeleton skeleton-text" style="width: 60%;"></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </main>

        <!-- Modal Master Tanda Tangan -->
        <div class="modal fade" id="modalMasterTTD" tabindex="-1" aria-labelledby="modalMasterTTDLabel" aria-hidden="true">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="modalMasterTTDLabel">
                  <i class="bi bi-pen me-2"></i>
                  Master Tanda Tangan
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <!-- Tabel Data Master TTD -->
                <div class="mb-4">
                  <h6 class="mb-3">Data Master Tanda Tangan yang Tersimpan</h6>
                  <div class="table-responsive">
                    <table class="table table-bordered table-hover" id="table-master-ttd">
                      <thead class="table-light">
                        <tr>
                          <th>Nama</th>
                          <th>Jabatan</th>
                          <th>Instansi</th>
                          <th>Golongan</th>
                          <th>NIP</th>
                        </tr>
                      </thead>
                      <tbody id="tbody-master-ttd">
                        <tr>
                          <td colspan="5" class="text-center text-muted">Tidak ada data</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
                
                <hr>
                
                <!-- Form Input/Edit -->
                <h6 class="mb-3">Form Master Tanda Tangan</h6>
                <form id="form-master-ttd">
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label for="ttd-nama" class="form-label">Nama <span class="text-danger">*</span></label>
                      <input type="text" class="form-control" id="ttd-nama" required>
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="ttd-jabatan" class="form-label">Jabatan <span class="text-danger">*</span></label>
                      <input type="text" class="form-control" id="ttd-jabatan" required>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label for="ttd-instansi" class="form-label">Instansi <span class="text-danger">*</span></label>
                      <input type="text" class="form-control" id="ttd-instansi" required>
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="ttd-golongan" class="form-label">Golongan</label>
                      <input type="text" class="form-control" id="ttd-golongan">
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label for="ttd-nip" class="form-label">NIP</label>
                      <input type="text" class="form-control" id="ttd-nip">
                    </div>
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                <button type="button" class="btn btn-primary" id="btn-save-master-ttd">
                  <i class="bi bi-save me-2"></i>
                  Simpan
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Modern Footer -->
        <footer class="footer-professional">
          <div class="footer-divider"></div>
          <div class="text-center">
            &copy; <span id="copyright-year"></span> Dinas Komunikasi, Informatika, Statistik, dan Persandian Kab. HST.
          </div>
        </footer>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="assets/js/config.js"></script>
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/admin-dashboard.js"></script>
    <script>
      // ===== MASTER TANDA TANGAN =====
      let masterTTD = null;

      // Update tabel Master TTD
      function updateMasterTTDTable(data) {
        const tbody = document.getElementById("tbody-master-ttd");
        if (!tbody) return;
        
        if (data) {
          tbody.innerHTML = `
            <tr>
              <td>${escapeHtml(data.nama || "-")}</td>
              <td>${escapeHtml(data.jabatan || "-")}</td>
              <td>${escapeHtml(data.instansi || "-")}</td>
              <td>${escapeHtml(data.golongan || "-")}</td>
              <td>${escapeHtml(data.nip || "-")}</td>
            </tr>
          `;
        } else {
          tbody.innerHTML = `
            <tr>
              <td colspan="5" class="text-center text-muted">Tidak ada data</td>
            </tr>
          `;
        }
      }

      // Helper function untuk escape HTML
      function escapeHtml(text) {
        if (!text) return "";
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // Load master tanda tangan
      async function loadMasterTTD() {
        try {
          const { data, error } = await sb
            .from("master_tanda_tangan")
            .select("*")
            .limit(1)
            .single();

          if (error && error.code !== 'PGRST116') {
            console.error("Error loading master TTD:", error);
            updateMasterTTDTable(null);
            return;
          }

          if (data) {
            masterTTD = data;
            updateMasterTTDTable(data);
            document.getElementById("ttd-nama").value = data.nama || "";
            document.getElementById("ttd-jabatan").value = data.jabatan || "";
            document.getElementById("ttd-instansi").value = data.instansi || "";
            document.getElementById("ttd-golongan").value = data.golongan || "";
            document.getElementById("ttd-nip").value = data.nip || "";
          } else {
            updateMasterTTDTable(null);
            document.getElementById("ttd-nama").value = "";
            document.getElementById("ttd-jabatan").value = "";
            document.getElementById("ttd-instansi").value = "";
            document.getElementById("ttd-golongan").value = "";
            document.getElementById("ttd-nip").value = "";
          }
        } catch (error) {
          console.error("Error loading master TTD:", error);
          updateMasterTTDTable(null);
        }
      }

      // Save master tanda tangan
      async function saveMasterTTD() {
        const nama = document.getElementById("ttd-nama").value.trim();
        const jabatan = document.getElementById("ttd-jabatan").value.trim();
        const instansi = document.getElementById("ttd-instansi").value.trim();
        const golongan = document.getElementById("ttd-golongan").value.trim();
        const nip = document.getElementById("ttd-nip").value.trim();

        if (!nama || !jabatan || !instansi) {
          alert("Nama, Jabatan, dan Instansi wajib diisi!");
          return;
        }

        try {
          const dataToSave = {
            nama,
            jabatan,
            instansi,
            golongan: golongan || null,
            nip: nip || null,
            updated_at: new Date().toISOString()
          };

          if (masterTTD && masterTTD.id) {
            const { data, error } = await sb
              .from("master_tanda_tangan")
              .update(dataToSave)
              .eq("id", masterTTD.id)
              .select()
              .single();

            if (error) throw error;
            masterTTD = data;
            updateMasterTTDTable(data);
            alert("Master tanda tangan berhasil diperbarui!");
          } else {
            const { data, error } = await sb
              .from("master_tanda_tangan")
              .insert(dataToSave)
              .select()
              .single();

            if (error) throw error;
            masterTTD = data;
            updateMasterTTDTable(data);
            alert("Master tanda tangan berhasil disimpan!");
          }

          await loadMasterTTD();
          const modal = bootstrap.Modal.getInstance(document.getElementById("modalMasterTTD"));
          if (modal) modal.hide();
        } catch (error) {
          console.error("Error saving master TTD:", error);
          alert("Gagal menyimpan master tanda tangan: " + error.message);
        }
      }

      // Event listeners
      document.addEventListener("DOMContentLoaded", function() {
        const btnSave = document.getElementById("btn-save-master-ttd");
        const modal = document.getElementById("modalMasterTTD");
        
        if (btnSave) {
          btnSave.addEventListener("click", saveMasterTTD);
        }
        
        if (modal) {
          modal.addEventListener("show.bs.modal", loadMasterTTD);
        }
      });
    </script>
  </body>
</html>
