<!DOCTYPE html>
<html lang="id" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Form Kehadiran Acara</title>

    <!-- Bootstrap & Icons -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
      rel="stylesheet"
    />

    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap");

      /* --- MODERN CSS VARIABLES --- */
      :root {
        --border-radius: 12px;
        --border-radius-lg: 16px;
        --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --gradient-success: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        --gradient-warning: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        --gradient-info: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
      }

      :root[data-theme="light"] {
        --bg-main: #f8fafc;
        --bg-card: #ffffff;
        --text-primary: #1e293b;
        --text-secondary: #64748b;
        --text-muted: #94a3b8;
        --border-color: #e2e8f0;
        --border-hover: #cbd5e1;
        --nav-link-hover-bg: #f1f5f9;
        --nav-link-active-bg: #eff6ff;
        --nav-link-active-color: #3b82f6;
        --header-bg: #ffffff;
        --footer-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --event-title-bg: #f8fafc;
      }

      :root[data-theme="dark"] {
        --bg-main: #0f172a;
        --bg-card: #334155;
        --text-primary: #f8fafc;
        --text-secondary: #cbd5e1;
        --text-muted: #94a3b8;
        --border-color: #475569;
        --border-hover: #64748b;
        --nav-link-hover-bg: rgba(255, 255, 255, 0.05);
        --nav-link-active-bg: rgba(59, 130, 246, 0.1);
        --nav-link-active-color: #60a5fa;
        --header-bg: #1e293b;
        --footer-bg: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        --event-title-bg: #1e293b;
      }

      /* --- MODERN RESET & BASE --- */
      * {
        box-sizing: border-box;
      }

      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }

      body {
        background-color: var(--bg-main);
        color: var(--text-primary);
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        font-size: 14px;
        line-height: 1.6;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      main {
        flex: 1 1 auto;
      }

      /* --- MODERN NAVBAR --- */
      .navbar {
        background: var(--header-bg);
        border-bottom: 1px solid var(--border-color);
        padding: 1rem 0;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
      }

      .navbar-brand {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-primary);
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .navbar-brand i {
        font-size: 1.5rem;
        background: var(--gradient-primary);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .nav-link {
        color: var(--text-secondary);
        text-decoration: none;
        font-weight: 500;
        padding: 0.5rem 1rem;
        border-radius: var(--border-radius);
        transition: var(--transition);
      }

      .nav-link:hover {
        background: var(--nav-link-hover-bg);
        color: var(--text-primary);
      }

      .theme-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        border: none;
        background: var(--bg-card);
        color: var(--text-secondary);
        border-radius: var(--border-radius);
        transition: var(--transition);
        cursor: pointer;
      }

      .theme-toggle:hover {
        background: var(--nav-link-hover-bg);
        color: var(--text-primary);
      }

      /* --- MODERN FORM CONTAINER --- */
      .form-container {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-lg);
        padding: 2rem;
        box-shadow: var(--shadow-lg);
        position: relative;
        overflow: hidden;
      }

      .form-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--gradient-primary);
      }

      /* --- MODERN EVENT TITLE --- */
      .event-title {
        background: var(--event-title-bg);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        padding: 1.5rem;
        text-align: center;
        font-weight: 600;
        margin-bottom: 2rem;
        position: relative;
        overflow: hidden;
      }

      .event-title::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.1), transparent);
        animation: shimmer 3s infinite;
      }

      @keyframes shimmer {
        0% { left: -100%; }
        100% { left: 100%; }
      }

      .event-title .fw-bold {
        font-size: 1.25rem;
        color: var(--text-primary);
        position: relative;
        z-index: 1;
      }

      .event-title .small {
        color: var(--text-secondary);
        position: relative;
        z-index: 1;
      }

      /* --- MODERN FORM CONTROLS --- */
      .form-label {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
      }

      .form-control {
        background: var(--bg-main);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
        transition: var(--transition);
        color: var(--text-primary) !important;
      }

      .form-control:focus {
        outline: none;
        border-color: var(--nav-link-active-color);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        background: var(--bg-card);
        color: var(--text-primary) !important;
      }

      .form-control:not(:placeholder-shown) {
        color: var(--text-primary) !important;
      }

      .form-control::placeholder {
        color: var(--text-muted);
      }

      .form-check-input {
        background: var(--bg-main);
        border: 1px solid var(--border-color);
        transition: var(--transition);
      }

      .form-check-input:checked {
        background-color: var(--nav-link-active-color);
        border-color: var(--nav-link-active-color);
      }

      .form-check-label {
        color: var(--text-primary);
        font-weight: 500;
        cursor: pointer;
      }

      /* --- MODERN SIGNATURE PAD --- */
      .signature-pad-wrapper {
        position: relative;
        border: 2px dashed var(--border-color);
        border-radius: var(--border-radius);
        height: 220px;
        background: var(--bg-main);
        overflow: hidden;
        transition: var(--transition);
      }

      .signature-pad-wrapper:hover {
        border-color: var(--nav-link-active-color);
        background: var(--nav-link-hover-bg);
      }

      #signature-canvas {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        border-radius: var(--border-radius);
        cursor: crosshair;
        touch-action: none;
      }

      /* --- MODERN BUTTONS --- */
      .btn {
        border-radius: var(--border-radius);
        font-weight: 500;
        transition: var(--transition);
        border: none;
        padding: 0.75rem 1.5rem;
        font-size: 0.875rem;
      }

      .btn-primary {
        background: var(--gradient-primary);
        border: none;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
      }

      .btn-outline-secondary {
        border: 1px solid var(--border-color);
        color: var(--text-secondary);
        background: transparent;
      }

      .btn-outline-secondary:hover {
        background: var(--nav-link-hover-bg);
        color: var(--text-primary);
        transform: translateY(-1px);
      }

      /* --- MODERN FOOTER --- */
      .footer-bar {
        background: var(--footer-bg);
        color: #ffffff;
        padding: 1.5rem 0;
        text-align: center;
        font-size: 0.875rem;
        margin-top: auto;
      }

      /* --- MODERN UTILITIES --- */
      .help-text {
        color: var(--text-muted);
        font-size: 0.875rem;
      }

      .text-gradient {
        background: var(--gradient-primary);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      /* --- RESPONSIVE DESIGN --- */
      @media (max-width: 768px) {
        .form-container {
          padding: 1.5rem;
          margin: 1rem;
        }
        
        .event-title {
          padding: 1rem;
        }
        
        .signature-pad-wrapper {
          height: 180px;
        }
      }

      /* --- DARK MODE TEXT OVERRIDES --- */
      [data-theme="dark"] .text-secondary { 
        color: var(--text-secondary) !important; 
      }
      [data-theme="dark"] .text-muted { 
        color: var(--text-muted) !important; 
      }

      /* --- FORM INPUT DARK MODE FIXES --- */
      [data-theme="dark"] .form-control {
        color: var(--text-primary) !important;
        background-color: var(--bg-main) !important;
      }
      
      [data-theme="dark"] .form-control:focus {
        color: var(--text-primary) !important;
        background-color: var(--bg-card) !important;
      }
      
      [data-theme="dark"] .form-control::placeholder {
        color: var(--text-muted) !important;
      }
      
      [data-theme="dark"] input[type="text"],
      [data-theme="dark"] input[type="email"],
      [data-theme="dark"] input[type="tel"] {
        color: var(--text-primary) !important;
      }
    </style>
  </head>
  <body>
    <script>
      (function () {
        const t = localStorage.getItem("theme") || "dark";
        document.documentElement.setAttribute("data-theme", t);
      })();
    </script>

    <!-- MODERN NAVBAR -->
    <nav class="navbar navbar-expand-lg">
      <div class="container">
        <a class="navbar-brand" href="pilih-acara.html">
          <i class="bi bi-calendar-check"></i>
          <span>AbsensiPro</span>
        </a>
        <div class="ms-auto d-flex align-items-center gap-2">
          <a class="nav-link" href="pilih-acara.html">
            <i class="bi bi-house me-1"></i>
            Home
          </a>
          <a class="nav-link" href="login.html">
            <i class="bi bi-box-arrow-in-right me-1"></i>
            Login
          </a>
          <button
            class="theme-toggle"
            id="theme-toggle"
            type="button"
            aria-label="Ubah tema"
          >
            <i class="bi bi-sun-fill"></i>
          </button>
        </div>
      </div>
    </nav>

    <!-- MODERN CONTENT -->
    <main class="container my-5">
      <div class="row justify-content-center">
        <div class="col-lg-8">
          <!-- Page Header -->
          <div class="text-center mb-5">
            <h1 class="h2 mb-2 text-gradient">Form Kehadiran</h1>
            <p class="text-muted">Isi form di bawah ini untuk mendaftarkan kehadiran Anda</p>
          </div>

          <div class="form-container">
            <div class="event-title" id="event-title">Memuat judul acara…</div>

            <form id="attendance-form" autocomplete="on" novalidate>
              <div class="mb-3">
                <label for="nama" class="form-label"
                  >Nama <span class="text-danger">*</span></label
                >
                <input
                  id="nama"
                  class="form-control"
                  type="text"
                  placeholder="Masukkan nama Anda"
                  required
                />
              </div>

              <div class="mb-3">
                <label for="email" class="form-label">Email</label>
                <input
                  id="email"
                  class="form-control"
                  type="email"
                  placeholder="nama@contoh.com"
                />
                <div class="form-text help-text">
                  Opsional, tapi disarankan.
                </div>
              </div>

              <div class="mb-3">
                <label for="phone" class="form-label">No. Handphone</label>
                <input
                  id="phone"
                  class="form-control"
                  type="tel"
                  placeholder="08xxxxxxxxxx"
                />
                <div class="form-text help-text">
                  Opsional, tapi disarankan.
                </div>
              </div>

              <div class="mb-3">
                <label for="jabatan" class="form-label">Jabatan</label>
                <input
                  id="jabatan"
                  class="form-control"
                  type="text"
                  placeholder="Masukkan jabatan Anda"
                />
              </div>

              <div class="mb-3">
                <label for="instansi" class="form-label"
                  >Instansi / Unit Kerja</label
                >
                <input
                  id="instansi"
                  class="form-control"
                  type="text"
                  placeholder="Masukkan instansi Anda"
                />
              </div>

              <div class="mb-3">
                <label class="form-label">Jenis Kelamin</label>
                <div class="d-flex gap-3">
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="gender" id="gender-m" value="male" />
                    <label class="form-check-label" for="gender-m">Laki-laki</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="gender" id="gender-f" value="female" />
                    <label class="form-check-label" for="gender-f">Perempuan</label>
                  </div>
                </div>
                <div class="form-text help-text">Opsional.</div>
              </div>

              <div class="mb-3">
                <label class="form-label" for="signature-canvas"
                  >Tanda Tangan / Signature</label
                >
                <div id="signature-wrapper" class="signature-pad-wrapper">
                  <canvas id="signature-canvas"></canvas>
                </div>
                <div class="form-text help-text">
                  Opsional. Jika dibubuhkan, akan terunggah ke Storage.
                </div>
              </div>

              <div class="d-flex justify-content-end gap-2">
                <button
                  type="button"
                  class="btn btn-outline-secondary"
                  id="clear-signature"
                >
                  Hapus Tanda Tangan
                </button>
                <button
                  type="submit"
                  class="btn btn-primary"
                  id="submit-button"
                >
                  Hadir
                </button>
              </div>
            </form>

            <div id="bad-link" class="alert alert-warning mt-3 d-none">
              Link acara tidak valid. Silakan kembali ke
              <a href="pilih-acara.html" class="alert-link">Pilih Acara</a>.
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- FOOTER -->
    <footer class="footer-bar">
      <div class="container text-center">
        &copy; <span id="copyright-year"></span> Diskominfo Hulu Sungai Tengah.
      </div>
    </footer>

    <!-- LIBS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <script src="assets/js/config.js"></script>

    <!-- PAGE LOGIC -->
    <script>
      document.getElementById("copyright-year").textContent =
        new Date().getFullYear();
      const htmlEl = document.documentElement;
      const themeToggle = document.getElementById("theme-toggle");
      
      function updateThemeIcon() {
        const isDark = htmlEl.getAttribute("data-theme") === "dark";
        themeToggle.innerHTML = isDark ? '<i class="bi bi-sun-fill"></i>' : '<i class="bi bi-moon-fill"></i>';
      }
      
      themeToggle.addEventListener("click", () => {
        const next = htmlEl.getAttribute("data-theme") === "dark" ? "light" : "dark";
        htmlEl.setAttribute("data-theme", next);
        localStorage.setItem("theme", next);
        updateThemeIcon();
        
        // Update signature pad pen color when theme changes
        if (signaturePad) {
          signaturePad.penColor = next === "dark" ? "#ffffff" : "#111827";
        }
      });
      
      updateThemeIcon();

      const sb = supabase.createClient(
        window.SUPABASE_URL,
        window.SUPABASE_ANON_KEY
      );

      const $form = document.getElementById("attendance-form");
      const $btn = document.getElementById("submit-button");
      const $nama = document.getElementById("nama");
      const $email = document.getElementById("email");
      const $phone = document.getElementById("phone");
      const $jabatan = document.getElementById("jabatan");
      const $instansi = document.getElementById("instansi");
      const $genderRadios = () => (document.querySelector('input[name="gender"]:checked')?.value || "");
      const $titleBox = document.getElementById("event-title");
      const $badLink = document.getElementById("bad-link");

      const wrapper = document.getElementById("signature-wrapper");
      const canvas = document.getElementById("signature-canvas");
      let signaturePad = null;

      function resizeCanvas() {
        if (!canvas || !wrapper) return;
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        const w = wrapper.clientWidth || 600;
        const h = wrapper.clientHeight || 220;
        canvas.style.width = w + "px";
        canvas.style.height = h + "px";
        canvas.width = Math.floor(w * ratio);
        canvas.height = Math.floor(h * ratio);
        const ctx = canvas.getContext("2d");
        ctx.scale(ratio, ratio);
        if (!signaturePad || signaturePad.isEmpty()) ctx.clearRect(0, 0, w, h);
      }

      document.addEventListener("DOMContentLoaded", () => {
        // Get current theme to set appropriate pen color
        const isDark = htmlEl.getAttribute("data-theme") === "dark";
        signaturePad = new SignaturePad(canvas, {
          backgroundColor: "rgba(0,0,0,0)",
          penColor: isDark ? "#ffffff" : "#111827",
        });
        resizeCanvas();
      });
      window.addEventListener("resize", resizeCanvas);
      document
        .getElementById("clear-signature")
        ?.addEventListener("click", () => signaturePad?.clear());

      const sleep = (ms) => new Promise((r) => setTimeout(r, ms));
      const trim = (v) => (v ?? "").toString().trim();
      function normalizePhone(input) {
        const raw = trim(input);
        if (!raw) return "";
        let s = raw.replace(/[^0-9+]/g, "");
        if (s.startsWith("+")) s = s.slice(1);
        if (s.startsWith("0")) s = "62" + s.slice(1);
        return s;
      }
      const esc = (s) =>
        (s ?? "").toString().replace(
          /[&<>"']/g,
          (m) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[m])
        );

      const params = new URLSearchParams(location.search);
      const eventId = params.get("event");

      async function loadEventTitle() {
        if (!eventId) {
          $titleBox.textContent =
            "Link acara tidak valid. Gunakan tautan dari admin.";
          $btn.disabled = true;
          $badLink.classList.remove("d-none");
          return;
        }
        const { data, error } = await sb
          .from("events")
          .select("id,title,datetime,location,status")
          .eq("id", eventId)
          .single();
        if (error || !data) {
          $titleBox.textContent =
            "Acara tidak ditemukan atau link tidak valid.";
          $btn.disabled = true;
          $badLink.classList.remove("d-none");
          return;
        }
        const dt = data.datetime ? new Date(data.datetime) : null;
        const meta = dt
          ? dt.toLocaleString("id-ID", {
              day: "2-digit",
              month: "short",
              year: "numeric",
              hour: "2-digit",
              minute: "2-digit",
            })
          : "";
        $titleBox.innerHTML = `
          <div class="fw-bold">${esc(data.title || "Tanpa Judul")}</div>
          <div class="small text-secondary">${esc(data.location || "-")}${
          meta ? " • " + meta : ""
        }</div>
        `;
        if (data.status === "done") {
          $btn.disabled = true;
          $btn.textContent = "Acara Selesai";
        }
      }
      loadEventTitle();

      // SUBMIT dengan upload tanda tangan aktif
      $form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const name = trim($nama.value);
        if (!name) {
          alert("Nama wajib diisi.");
          $nama.focus();
          return;
        }
        if (!eventId) {
          alert("Link acara tidak valid.");
          return;
        }

        const oldText = $btn.textContent;
        $btn.disabled = true;
        $btn.textContent = "Menyimpan…";

        try {
          // 1) Upload signature bila ada coretan
          let signature_url = null;
          if (signaturePad && !signaturePad.isEmpty()) {
            // Double check that signature pad actually has content
            const canvas = document.getElementById("signature-canvas");
            const ctx = canvas.getContext("2d");
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const hasContent = imageData.data.some((pixel, index) => {
              // Check if any pixel has non-transparent alpha (every 4th value is alpha)
              return index % 4 === 3 && pixel > 0;
            });
            
            if (!hasContent) {
              console.log("Signature pad appears empty, skipping upload");
            } else {
            try {
              console.log("Starting signature upload...");
              
              const blob = await new Promise((resolve, reject) => {
                try {
                  const c = document.getElementById("signature-canvas");
                  c.toBlob((b) => {
                    if (b) {
                      console.log("Blob created successfully, size:", b.size);
                      resolve(b);
                    } else {
                      console.error("Failed to create blob");
                      reject(new Error("Gagal membuat blob tanda tangan."));
                    }
                  }, "image/png");
                } catch (e) {
                  console.error("Error creating blob:", e);
                  reject(e);
                }
              });

              // Retry mechanism for signature upload
              const maxRetries = 3;
              let retryCount = 0;
              let uploadSuccess = false;

              while (retryCount < maxRetries && !uploadSuccess) {
                try {
                  const rand = Math.random().toString(36).slice(2, 8);
                  const path = `event_${eventId}/${Date.now()}_${rand}_${retryCount}.png`;
                  console.log(`Upload attempt ${retryCount + 1}/${maxRetries}, path:`, path);

                  // Check if storage bucket exists and is accessible
                  console.log("Checking storage buckets...");
                  const { data: bucketList, error: bucketError } = await sb.storage.listBuckets();
                  
                  if (bucketError) {
                    console.error("Cannot access storage buckets:", bucketError);
                    console.error("Bucket error details:", {
                      message: bucketError.message,
                      statusCode: bucketError.statusCode,
                      error: bucketError.error
                    });
                    throw new Error("Storage tidak dapat diakses");
                  }
                  
                  console.log("Available buckets:", bucketList);
                  
                  const signaturesBucket = bucketList?.find(bucket => bucket.name === "signatures");
                  if (!signaturesBucket) {
                    console.error("Signatures bucket not found in available buckets:", bucketList?.map(b => b.name));
                    console.error("Creating signatures bucket...");
                    
                    // Try to create the bucket
                    const { data: createData, error: createError } = await sb.storage.createBucket("signatures", {
                      public: true,
                      allowedMimeTypes: ["image/png", "image/jpeg", "image/gif"],
                      fileSizeLimit: 5242880 // 5MB
                    });
                    
                    if (createError) {
                      console.error("Failed to create signatures bucket:", createError);
                      throw new Error("Bucket 'signatures' tidak ditemukan dan gagal dibuat");
                    } else {
                      console.log("Signatures bucket created successfully:", createData);
                    }
                  } else {
                    console.log("Signatures bucket found:", signaturesBucket);
                  }

                  const { data: upData, error: upErr } = await sb.storage
                    .from("signatures")
                    .upload(path, blob, {
                      contentType: "image/png",
                      upsert: true,
                      cacheControl: "3600",
                    });

                  if (upErr) {
                    console.error(`Upload attempt ${retryCount + 1} failed:`, upErr);
                    console.error("Error details:", {
                      message: upErr.message,
                      statusCode: upErr.statusCode,
                      error: upErr.error,
                      details: upErr.details,
                      hint: upErr.hint
                    });
                    
                    // Check if it's a permission error
                    if (upErr.message && upErr.message.includes("permission")) {
                      console.error("PERMISSION ERROR: Bucket 'signatures' mungkin tidak memiliki permission yang benar");
                      console.error("Pastikan bucket 'signatures' memiliki public access");
                    }
                    
                    // Check if it's a bucket not found error
                    if (upErr.message && upErr.message.includes("not found")) {
                      console.error("BUCKET NOT FOUND: Bucket 'signatures' tidak ditemukan");
                    }
                    
                    retryCount++;
                    if (retryCount < maxRetries) {
                      console.log(`Retrying in 1 second... (${retryCount}/${maxRetries})`);
                      await new Promise(resolve => setTimeout(resolve, 1000));
                      continue;
                    } else {
                      console.error("All upload attempts failed");
                      break;
                    }
                  } else if (upData) {
                    console.log("Upload successful:", upData);
                    const { data: pub } = sb.storage.from("signatures").getPublicUrl(path);
                    signature_url = pub?.publicUrl || null;
                    console.log("Public URL:", signature_url);
                    uploadSuccess = true;
                  } else {
                    console.warn("Upload completed but no data returned");
                    retryCount++;
                    if (retryCount < maxRetries) {
                      console.log(`Retrying in 1 second... (${retryCount}/${maxRetries})`);
                      await new Promise(resolve => setTimeout(resolve, 1000));
                      continue;
                    }
                  }
                } catch (retryError) {
                  console.error(`Retry attempt ${retryCount + 1} failed:`, retryError);
                  retryCount++;
                  if (retryCount < maxRetries) {
                    console.log(`Retrying in 1 second... (${retryCount}/${maxRetries})`);
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    continue;
                  } else {
                    console.error("All retry attempts failed");
                    break;
                  }
                }
              }

              if (!uploadSuccess) {
                console.warn("Signature upload failed after all retries, trying base64 fallback...");
                
                // Fallback: Convert signature to base64 and store in database
                try {
                  const canvas = document.getElementById("signature-canvas");
                  const base64Signature = canvas.toDataURL("image/png");
                  console.log("Base64 signature created, length:", base64Signature.length);
                  
                  // Store base64 signature as fallback when storage upload fails
                  console.log("Base64 signature (first 100 chars):", base64Signature.substring(0, 100) + "...");
                  
                  // Use base64 as signature_url when storage upload fails
                  signature_url = base64Signature;
                  console.log("Using base64 signature as fallback, length:", signature_url.length);
                  
                } catch (base64Error) {
                  console.error("Base64 fallback also failed:", base64Error);
                }
              }

            } catch (signatureError) {
              console.error("Signature upload failed:", signatureError);
              // Continue without signature rather than failing the entire form
            }
            }
          }

          // 2) Insert baris ke 'attendees'
          const payload = {
            event_id: eventId,
            name,
            instansi: trim($instansi.value) || null,
            jabatan: trim($jabatan.value) || null,
            email: trim($email.value) || null,
            phone: normalizePhone($phone.value) || null,
            ts: new Date().toISOString(),
            signature_url,
            gender: (function(){ const g=$genderRadios(); return g?g:null; })(),
          };
          
          console.log("Final payload before database insert:", {
            name: payload.name,
            signature_url: payload.signature_url,
            has_signature: !!payload.signature_url,
            signature_length: payload.signature_url ? payload.signature_url.length : 0
          });
          // Insert terlebih dahulu. Jika kena unik, fallback ke UPDATE
          let ins = await sb.from("attendees").insert(payload);
          if (ins.error) {
            // Jika insert gagal karena constraint unik (23505 / 409), fallback ke UPDATE berdasarkan event_id+phone
            const code = String(ins.error.code || "");
            if ((code === "23505" || ins.status === 409) && payload.phone) {
              const upd = await sb
                .from("attendees")
                .update(payload)
                .eq("event_id", eventId)
                .eq("phone", payload.phone);
              if (upd.error) throw upd.error;
              console.log("Database UPDATE successful with signature_url:", payload.signature_url);
            } else {
              throw ins.error;
            }
          } else {
            console.log("Database INSERT successful with signature_url:", payload.signature_url);
          }

          // 3) Beres
          $form.reset();
          signaturePad?.clear();
          $btn.textContent = "Tersimpan ✓";
          await sleep(900);
          $btn.textContent = oldText;
          alert("Terima kasih! Kehadiran Anda sudah tercatat.");
        } catch (err) {
          console.error(err);
          alert("Gagal menyimpan kehadiran. Coba lagi ya.");
          $btn.textContent = oldText;
        } finally {
          $btn.disabled = false;
        }
      });
    </script>
  </body>
</html>
